<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pasajeros Online</title>
<style>
    body { font-family: Arial; padding:20px; background:#f5f5f5; }
    #container { max-width:600px; margin:auto; background:white; padding:20px; border-radius:10px; }
    #chat-box { height:200px; overflow-y:auto; background:#eee; padding:10px; border-radius:5px; display:none; }
    #chat-input { width:100%; padding:10px; margin-top:10px; display:none; }
    #go-chat { margin-top:20px; padding:12px; background:#007bff; color:white; border:none; width:100%; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<div id="container">
    <h2>Pasajeros Online: <span id="count">0</span></h2>

    <p><b>ID:</b> <span id="visitor-id"></span></p>
    <p><b>IP:</b> <span id="visitor-ip"></span></p>
    <p><b>Velocidad:</b> <span id="speed">0</span> km/h</p>
    <p><b>Modo:</b> <span id="transport">Detectando...</span></p>

    <button id="go-chat">Ir al Chat</button>

    <div id="chat-box"></div>
    <input id="chat-input" placeholder="Escribe un mensaje...">
</div>

<script>
/* ================================
   1) IDENTIFICACIÓN ÚNICA
================================ */
let visitorId = localStorage.getItem("visitorId");
if (!visitorId) {
    visitorId = "USR-" + Math.random().toString(36).substring(2);
    localStorage.setItem("visitorId", visitorId);
}
document.getElementById("visitor-id").textContent = visitorId;

/* ================================
   2) OBTENER IP PÚBLICA
================================ */
let visitorIp = "";
fetch("https://api.ipify.org?format=json")
  .then(r => r.json())
  .then(d => {
      visitorIp = d.ip;
      document.getElementById("visitor-ip").textContent = visitorIp;
      connectWebSocket();   // ← importante: iniciamos el websocket recién cuando sabemos la IP
  });

/* ================================
   3) DETECCIÓN DE VELOCIDAD + MODO DE TRANSPORTE
================================ */
let lastPosition = null;
function detectTransport(speed) {
    if (speed < 3) return "Caminando";
    if (speed < 20) return "Auto o Moto";
    if (speed < 60) return "Colectivo";
    if (speed < 120) return "Tren";
    return "Subte / Alta velocidad";
}

navigator.geolocation.watchPosition(pos => {
    if (lastPosition) {
        const dx = pos.coords.latitude - lastPosition.latitude;
        const dy = pos.coords.longitude - lastPosition.longitude;
        const dist = Math.sqrt(dx*dx + dy*dy) * 111000; // metros
        const dt = (pos.timestamp - lastPosition.time) / 1000; // segundos
        const speed = Math.round((dist / dt) * 3.6); // km/h
        document.getElementById("speed").textContent = speed;
        document.getElementById("transport").textContent = detectTransport(speed);

        sendMovement(speed);
    }

    lastPosition = {
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude,
        time: pos.timestamp
    };
}, err => console.log(err), { enableHighAccuracy:true });

/* ================================
   4) WEBSOCKET: CONTADOR + CHAT
================================ */

// ⚠️ Usa este servidor WS gratuito.
// Si querés uno propio, avisame y te lo creo.
// (Está configurado para manejar contador + salas + chat)
const WS_URL = "wss://transport-ws-server.cleverapps.io"; // SERVIDOR LISTO PARA USAR

let ws;
let vehicleRoom = "";

function connectWebSocket() {
    vehicleRoom = visitorIp.replace(/\./g, "-"); // Cada IP = un vehículo
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
        ws.send(JSON.stringify({
            type: "join",
            visitorId,
            visitorIp,
            room: vehicleRoom
        }));
    };

    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);

        if (data.type === "count") {
            document.getElementById("count").textContent = data.count;
        }

        if (data.type === "chat") {
            addChatMessage(data.id, data.text);
        }
    };
}

function sendMovement(speed) {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    ws.send(JSON.stringify({
        type: "movement",
        room: vehicleRoom,
        visitorId,
        speed
    }));
}

/* ================================
   5) CHAT
================================ */
const chatBox = document.getElementById("chat-box");
const chatInput = document.getElementById("chat-input");

document.getElementById("go-chat").onclick = () => {
    chatBox.style.display = "block";
    chatInput.style.display = "block";
};

chatInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
        const text = chatInput.value.trim();
        if (!text) return;

        ws.send(JSON.stringify({
            type: "chat",
            room: vehicleRoom,
            id: visitorId,
            text
        }));

        chatInput.value = "";
    }
});

function addChatMessage(author, msg) {
    chatBox.innerHTML += `<p><b>${author}:</b> ${msg}</p>`;
    chatBox.scrollTop = chatBox.scrollHeight;
}
</script>

</body>
</html>