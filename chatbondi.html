<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pasajeros Online + Chat (GUN)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
<style>
  body{font-family:Inter,system-ui,Arial;margin:18px;background:#f5f7fb;color:#111}
  .card{background:#fff;border-radius:10px;padding:16px;margin-bottom:14px;box-shadow:0 6px 18px rgba(17,24,39,0.06)}
  #chatPanel{display:none}
  #messages{height:240px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fafafa}
  .msg{padding:6px;margin:6px 0;border-radius:6px;background:#e9f0ff}
  .msg.me{background:#dff7e5}
  button{padding:8px 12px;border-radius:8px;border:0;background:#0b74de;color:#fff;cursor:pointer}
  input,button,textarea{font-family:inherit}
</style>
</head>
<body>

<div class="card">
  <h2>Pasajeros Online: <span id="onlineCount">0</span></h2>
  <p><strong>ID:</strong> <span id="visitorId">cargando…</span></p>
  <p><strong>IP:</strong> <span id="visitorIp">cargando…</span></p>
</div>

<div class="card">
  <h3>Movimiento</h3>
  <p><strong>Velocidad:</strong> <span id="speed">0</span> km/h</p>
  <p><strong>Modo:</strong> <span id="transport">Detectando…</span></p>
  <button id="goChatBtn">Ir al chat</button>
</div>

<div id="chatPanel" class="card">
  <h3>Chat de vehículo <small id="roomLabel"></small></h3>
  <div id="messages"></div>
  <div style="margin-top:8px;display:flex;gap:8px">
    <input id="msgInput" placeholder="Escribí un mensaje..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd"/>
    <button id="sendBtn">Enviar</button>
  </div>
</div>

<!-- GUN -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>

<script>
(function(){
  // ---------- util ----------
  const log = (...a)=>console.log('[App]',...a);
  const now = ()=>Date.now();

  // ---------- visitorId (persistente) ----------
  let visitorId = localStorage.getItem('visitor_id');
  if (!visitorId) {
    visitorId = 'v_' + Math.random().toString(36).slice(2,10);
    localStorage.setItem('visitor_id', visitorId);
    log('Nuevo visitorId', visitorId);
  } else log('visitorId recuperado', visitorId);
  document.getElementById('visitorId').innerText = visitorId;

  // ---------- obtener IP pública (con fallback) ----------
  window.__USER_IP__ = '0.0.0.0';
  async function fetchIP(){
    try {
      const r = await fetch('https://api.ipify.org?format=json', {cache:'no-store'});
      if (!r.ok) throw new Error('status ' + r.status);
      const j = await r.json();
      window.__USER_IP__ = j.ip || '0.0.0.0';
      document.getElementById('visitorIp').innerText = window.__USER_IP__;
      log('IP pública', window.__USER_IP__);
    } catch(err) {
      log('No se pudo obtener IP pública:', err);
      document.getElementById('visitorIp').innerText = 'No disponible';
      window.__USER_IP__ = '0.0.0.0';
    }
  }
  fetchIP();

  // ---------- inicializar GUN ----------
  // peers públicos (si fallan, GUN usa mesh local)
  let gun;
  try {
    gun = Gun({ peers: ['https://gun-manhattan.herokuapp.com/gun', 'https://gun-us.herokuapp.com/gun'] });
    log('GUN inicializado');
  } catch(e){
    gun = Gun();
    log('GUN init fallback', e);
  }

  // ---------- Pasajeros online (heartbeat) ----------
  const onlineNode = gun.get('online-users');

  function heartbeat(){
    try {
      onlineNode.get(visitorId).put({ts: now()});
    } catch(e){ log('heartbeat error', e); }
  }
  heartbeat();
  const hbInterval = setInterval(heartbeat, 12000); // cada 12s

  // actualizar contador: cada 4s hacemos snapshot once()
  async function updateOnlineCount(){
    try {
      const cutoff = now() - 25000; // 25s
      onlineNode.once(data => {
        try {
          if (!data) { document.getElementById('onlineCount').innerText = '0'; return; }
          let count = 0;
          for (const k in data) {
            const v = data[k];
            let ts = 0;
            if (v && typeof v === 'object' && v.ts) ts = v.ts;
            else if (typeof v === 'number') ts = v;
            if (ts > cutoff) count++;
          }
          document.getElementById('onlineCount').innerText = count;
        } catch(e){ log('procesando snapshot', e); }
      });
    } catch(e){ log('updateOnlineCount error', e); }
  }
  updateOnlineCount();
  const countInterval = setInterval(updateOnlineCount, 4000);

  // ---------- GPS: velocidad y clasificación ----------
  let last = null;
  let currentSpeedKmh = 0;
  function haversineKm(aLat,aLon,bLat,bLon){
    const R = 6371;
    const dLat = (bLat-aLat) * Math.PI/180;
    const dLon = (bLon-aLon) * Math.PI/180;
    const A = Math.sin(dLat/2)**2 + Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
  }
  function classify(speed, acc){
    if (acc > 150) return 'Subte (señal baja)';
    if (speed < 6) return 'Caminando';
    if (speed < 25) return 'Auto/Bici/Moto';
    if (speed < 50) return 'Colectivo';
    if (speed < 130) return 'Tren';
    return 'Desconocido';
  }
  function onPos(p){
    try {
      const lat = p.coords.latitude, lon = p.coords.longitude, acc = p.coords.accuracy || 999;
      if (last) {
        const distKm = haversineKm(last.lat,last.lon,lat,lon);
        const dtH = (p.timestamp - last.t) / 3600000;
        let sp = dtH > 0 ? (distKm / dtH) : 0;
        if (!isFinite(sp)) sp = 0;
        currentSpeedKmh = Math.max(0, sp);
        document.getElementById('speed').innerText = currentSpeedKmh.toFixed(1);
        document.getElementById('transport').innerText = classify(currentSpeedKmh, acc);
        // enviar movimiento al nodo (opcional para logs)
        try { gun.get('movement').get(visitorId).put({lat,lon,speed:currentSpeedKmh,ts: now()}); } catch(e){/*ignore*/ }
      }
      last = {lat,lon,t:p.timestamp};
    } catch(e){ log('onPos error', e); }
  }
  if (navigator.geolocation){
    navigator.geolocation.watchPosition(onPos, err=>log('GPS error',err), {enableHighAccuracy:true, maximumAge:1000, timeout:8000});
  } else log('Geolocation no disponible');

  // ---------- Chat por vehículo ----------
  // RoomKey simple: ip + speedRound
  function roomKey(){
    const ip = window.__USER_IP__ || '0.0.0.0';
    const sp = Math.round(currentSpeedKmh || 0);
    return btoa(ip + '_' + sp).replace(/=/g,'');
  }

  const goChatBtn = document.getElementById('goChatBtn');
  const chatPanel = document.getElementById('chatPanel');
  const messagesEl = document.getElementById('messages');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  let roomNode = null;
  let seenMsgKeys = new Set();

  function openChat(){
    chatPanel.style.display = 'block';
    const rk = roomKey();
    document.getElementById('roomLabel').innerText = ' ' + rk.slice(0,10);
    roomNode = gun.get('chat-' + rk);
    messagesEl.innerHTML = '';
    seenMsgKeys.clear();

    // escuchar mensajes (map)
    roomNode.map().on((data, id) => {
      try {
        if (!data) return;
        // Evitar re-dibujar mensajes duplicados
        const key = id || (data.ts + '|' + (data.sender||'x'));
        if (seenMsgKeys.has(key)) return;
        seenMsgKeys.add(key);
        const div = document.createElement('div');
        div.className = 'msg ' + (data.sender === visitorId ? 'me':'');
        div.innerHTML = `<strong>${(data.sender||'anon').slice(0,8)}:</strong> ${escapeHtml(data.text||'')}`;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch(e){ log('error procesando msg', e); }
    });
  }

  goChatBtn.addEventListener('click', openChat);

  function sendMessage(){
    const text = (msgInput.value||'').trim();
    if (!text) return;
    if (!roomNode) openChat();
    const msg = { sender: visitorId, text, ts: now() };
    try {
      roomNode.set(msg);
      msgInput.value = '';
    } catch(e){ log('error sending msg', e); }
  }
  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

  // escapeHtml
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ---------- cleanup on unload ----------
  window.addEventListener('beforeunload', () => {
    try { onlineNode.get(visitorId).put(null); } catch(e){ /*ignore*/ }
    clearInterval(hbInterval); clearInterval(countInterval);
  });

  // expose for debug
  window.__APP__ = { gun, visitorId, roomKey };
})();
</script>
</body>
</html>