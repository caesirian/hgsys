<!-- Agrega esto en tu HTML, en el script, reemplazando la clase ChatHernan -->

<script>
class ChatHernanIA {
    constructor() {
        this.chatVisible = false;
        this.messages = [];
        this.revelationLevel = 0;
        this.sessionId = this.generateSessionId();
        this.GAS_URL = 'https://script.google.com/macros/s/AKfycbxOb_e44G3RMoW3Kcgco6KHJkWX9-5dchDtEq_LofpCQ8uX83hvVpWEy0G-rOd_apd5/exec';
        this.isTyping = false;
        
        this.initializeElements();
        this.setupEventListeners();
        this.showWelcomeMessage();
        this.setupAutoContact();
    }

    generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    initializeElements() {
        this.chatToggle = document.getElementById('chat-toggle');
        this.chatContainer = document.getElementById('chat-container');
        this.closeChat = document.getElementById('close-chat');
        this.userInput = document.getElementById('user-input');
        this.sendBtn = document.getElementById('send-btn');
        this.chatMessages = document.getElementById('chat-messages');
        this.chatName = document.getElementById('chat-name');
        this.chatStatus = document.getElementById('chat-status');
    }

    setupEventListeners() {
        this.chatToggle.addEventListener('click', () => this.toggleChat());
        this.closeChat.addEventListener('click', () => this.hideChat());
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        
        this.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        // Auto-completar preguntas comunes
        this.setupQuickQuestions();
    }

    setupQuickQuestions() {
        // Botones de preguntas comunes (opcional)
        const quickQuestions = [
            "Â¿QuÃ© servicios ofreces?",
            "Â¿QuÃ© tecnologÃ­as manejas?",
            "Â¿Tienes experiencia con e-commerce?",
            "Â¿CÃ³mo es tu metodologÃ­a de trabajo?",
            "Â¿Puedo ver algunos proyectos?"
        ];

        // Puedes agregar botones flotantes con estas preguntas
    }

    setupAutoContact() {
        // Mostrar contacto despuÃ©s de 5 minutos de conversaciÃ³n
        setTimeout(() => {
            if (this.messages.length > 4) {
                this.showContactSuggestions();
            }
        }, 300000);
    }

    showWelcomeMessage() {
        const welcomeMessages = [
            {
                glitch: "Sistema de conocimiento cargado âœ“",
                text: "Â¡Hola! Soy HernÃ¡n, especialista en desarrollo web y soluciones digitales. Estoy aquÃ­ para contarte sobre mis servicios, habilidades y cÃ³mo puedo ayudarte con tu proyecto.",
                time: this.getCurrentTime()
            },
            {
                glitch: "Base de datos: Proyectos y tecnologÃ­as",
                text: "PregÃºntame sobre: desarrollo web, e-commerce, tecnologÃ­as que uso, casos de Ã©xito o mi metodologÃ­a de trabajo.",
                time: this.getCurrentTime()
            }
        ];
        
        welcomeMessages.forEach(msg => {
            this.addMessage(msg.text, 'bot', msg.glitch);
        });
    }

    async sendMessage() {
        if (this.isTyping) return;
        
        const message = this.userInput.value.trim();
        if (!message) return;

        // Mostrar mensaje del usuario
        this.addMessage(message, 'user');
        this.userInput.value = '';
        this.isTyping = true;
        
        // Mostrar "escribiendo" con efecto especial
        const typingIndicator = this.showTypingIndicator("Analizando tu consulta...");
        
        try {
            // Llamar al backend IA
            const response = await this.getAIResponse(message);
            
            typingIndicator.remove();
            this.isTyping = false;
            
            // Procesar respuesta estructurada
            if (response.success) {
                // Actualizar nivel de revelaciÃ³n si cambiÃ³
                if (response.revelationLevel !== undefined && response.revelationLevel !== this.revelationLevel) {
                    this.revelationLevel = response.revelationLevel;
                    this.updateChatName(this.revelationLevel);
                }
                
                // Mostrar respuesta de la IA
                this.addMessage(response.reply, 'bot');
                
                // Mostrar info de contacto si es necesario
                if (response.showContactInfo) {
                    setTimeout(() => this.showContactCard(), 1000);
                }
                
                // Sugerir preguntas relacionadas
                this.suggestRelatedQuestions(message);
                
            } else {
                this.addMessage(response.reply, 'bot');
            }
            
        } catch (error) {
            console.error('Error:', error);
            typingIndicator.remove();
            this.isTyping = false;
            
            // Respuesta de error con sugerencias
            const fallbackResponses = [
                "Parece que hay un problema de conexiÃ³n. Mientras tanto, te cuento que me especializo en desarrollo web con React y Node.js, y creaciÃ³n de e-commerces con Shopify.",
                "Error temporal. Para darte una idea rÃ¡pida: trabajo con tecnologÃ­as modernas, desarrollo sitios responsivos y sistemas personalizados. Â¿En quÃ© Ã¡rea te interesa saber mÃ¡s?"
            ];
            
            const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            this.addMessage(randomResponse, 'bot', "ConexiÃ³n inestable");
        }
    }

    async getAIResponse(userMessage) {
        const response = await fetch(this.GAS_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: userMessage,
                sessionId: this.sessionId,
                revelationLevel: this.revelationLevel,
                timestamp: new Date().toISOString()
            })
        });
        
        return await response.json();
    }

    updateChatName(level) {
        const names = [
            "HernÃ¡n - Especialista Web",
            "HernÃ¡n Garbarino",
            "HernÃ¡n Garbarino (Digital)"
        ];
        
        if (level >= 0 && level < names.length) {
            this.chatName.textContent = names[level];
        }
    }

    suggestRelatedQuestions(userMessage) {
        const lowerMsg = userMessage.toLowerCase();
        const suggestions = {
            'servicio': [
                "Â¿Quieres saber mÃ¡s sobre alguna tecnologÃ­a especÃ­fica?",
                "Â¿Te interesa conocer casos similares que he trabajado?"
            ],
            'tecnolog': [
                "Â¿Te gustarÃ­a que te cuente sobre proyectos reales usando estas tecnologÃ­as?",
                "Â¿Necesitas ayuda para elegir la mejor tecnologÃ­a para tu proyecto?"
            ],
            'e-commerce': [
                "Â¿Quieres detalles sobre integraciÃ³n con mÃ©todos de pago?",
                "Â¿Te interesa saber sobre optimizaciÃ³n de conversiones?"
            ],
            'proyecto': [
                "Â¿Quieres que te cuente sobre metodologÃ­a y tiempos?",
                "Â¿Te gustarÃ­a coordinar una consulta para evaluar tu idea?"
            ]
        };
        
        for (const [keyword, suggs] of Object.entries(suggestions)) {
            if (lowerMsg.includes(keyword) && Math.random() > 0.5) {
                setTimeout(() => {
                    this.addMessage(suggs[Math.floor(Math.random() * suggs.length)], 'bot', "Sugerencia relacionada");
                }, 1500);
                break;
            }
        }
    }

    showContactCard() {
        const contactHTML = `
            <div class="message bot-message" id="contact-suggestion">
                <div class="message-content">
                    <div class="glitch-text">Info de contacto disponible</div>
                    <div class="message-text">
                        <strong>Â¿Te gustarÃ­a conversar mÃ¡s sobre tu proyecto?</strong>
                        <br><br>
                        Para consultas detalladas o presupuestos:
                        <br>
                        ðŸ“§ <a href="mailto:hernan.garbarino@gmail.com" style="color:#0f0;">hernan.garbarino@gmail.com</a>
                        <br>
                        ðŸ“± <a href="https://wa.me/541134796562" style="color:#0f0;">+54 11 3479-6562</a>
                        <br><br>
                        <small>Disponible para nuevas oportunidades y proyectos interesantes.</small>
                    </div>
                    <div class="message-time">Contacto</div>
                </div>
            </div>
        `;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = contactHTML;
        this.chatMessages.appendChild(tempDiv.firstElementChild);
        this.scrollToBottom();
    }

    showContactSuggestions() {
        const suggestions = [
            "Â¿Te gustarÃ­a coordinar una llamada para hablar mÃ¡s sobre tu proyecto?",
            "Si necesitas un presupuesto detallado, podemos coordinar por email o WhatsApp.",
            "Para proyectos especÃ­ficos, lo mejor es una consulta personalizada. Â¿Te interesa?"
        ];
        
        if (!this.contactShown) {
            setTimeout(() => {
                this.addMessage(suggestions[Math.floor(Math.random() * suggestions.length)], 'bot', "Sugerencia");
                this.contactShown = true;
            }, 5000);
        }
    }

    addMessage(text, sender, glitchText = '') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        
        // Efectos de formateo para respuestas tÃ©cnicas
        let formattedText = this.formatTechnicalResponse(text);
        
        const timeString = this.getCurrentTime();
        
        messageDiv.innerHTML = `
            <div class="message-content">
                ${glitchText ? `<div class="glitch-text">${glitchText}</div>` : ''}
                <div class="message-text">${formattedText}</div>
                <div class="message-time">${timeString}</div>
            </div>
        `;
        
        this.chatMessages.appendChild(messageDiv);
        this.scrollToBottom();
        
        // AnimaciÃ³n de entrada
        setTimeout(() => {
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 10);
        
        // Guardar en historial
        this.messages.push({
            text: text,
            sender: sender,
            time: timeString
        });
    }

    formatTechnicalResponse(text) {
        // Mejorar formato para respuestas tÃ©cnicas
        let formatted = this.escapeHtml(text);
        
        // Destacar tecnologÃ­as
        const techKeywords = ['React', 'Node.js', 'JavaScript', 'Python', 'Shopify', 'WordPress', 'MongoDB', 'MySQL', 'AWS'];
        techKeywords.forEach(tech => {
            const regex = new RegExp(`\\b${tech}\\b`, 'gi');
            formatted = formatted.replace(regex, `<strong style="color:#667eea;">${tech}</strong>`);
        });
        
        // Destacar nÃºmeros y resultados
        formatted = formatted.replace(/\b(\d+%)\b/g, '<strong style="color:#4CAF50;">$1</strong>');
        formatted = formatted.replace(/\b(\d+\+?\s?aÃ±os?)\b/gi, '<strong style="color:#FF9800;">$1</strong>');
        
        // Mejorar listas
        formatted = formatted.replace(/â€¢/g, '<br>â€¢');
        formatted = formatted.replace(/\n/g, '<br>');
        
        return formatted;
    }

    showTypingIndicator(customText = "Analizando...") {
        const indicator = document.createElement('div');
        indicator.className = 'message bot-message';
        indicator.id = 'typing-indicator';
        indicator.innerHTML = `
            <div class="message-content">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span style="margin-left:10px;font-size:12px;color:#aaa;">${customText}</span>
                </div>
            </div>
        `;
        this.chatMessages.appendChild(indicator);
        this.scrollToBottom();
        return indicator;
    }

    scrollToBottom() {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    getCurrentTime() {
        const now = new Date();
        return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    toggleChat() {
        this.chatVisible ? this.hideChat() : this.showChat();
    }

    showChat() {
        this.chatVisible = true;
        this.chatContainer.classList.remove('chat-hidden');
        setTimeout(() => {
            this.chatContainer.classList.add('chat-visible');
            this.userInput.focus();
            this.chatStatus.textContent = 'Conectado âœ“';
        }, 10);
    }

    hideChat() {
        this.chatVisible = false;
        this.chatContainer.classList.remove('chat-visible');
        setTimeout(() => {
            this.chatContainer.classList.add('chat-hidden');
        }, 400);
    }
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    window.hernanChat = new ChatHernanIA();
});
</script>
