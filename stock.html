<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Stock - Biotecnolog√≠a</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { padding: 20px; background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
    h2 { margin-top: 20px; }
    .card { margin-bottom: 20px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .chart-container { position: relative; height: 300px; }
    table { background: #fff; border-radius: 8px; overflow: hidden; }
    th, td { text-align: center; vertical-align: middle; }
    th { background-color: #007bff; color: white; }
    .form-control { max-width: 150px; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">Gesti√≥n de Stock - Biotecnolog√≠a</h1>

    <!-- Indicadores de stock -->
    <div class="row">
      <div class="col-md-6">
        <div class="card p-3">
          <h2>üß¥ Stock de Envases</h2>
          <canvas id="envasesChart" class="chart-container"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3">
          <h2>üß™ Stock de Crudos</h2>
          <canvas id="crudosChart" class="chart-container"></canvas>
        </div>
      </div>
    </div>

    <!-- Formulario de fraccionamiento -->
    <div class="card p-3">
      <h2>‚ûï Registrar Fraccionamiento</h2>
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <label for="productoSelect" class="form-label">Producto</label>
          <select id="productoSelect" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label for="presentacionSelect" class="form-label">Presentaci√≥n</label>
          <select id="presentacionSelect" class="form-select">
            <option>45ml</option>
            <option>200ml</option>
            <option>500ml</option>
            <option>1lts</option>
            <option>5lts</option>
            <option>20lts</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="cantidadInput" class="form-label">Cantidad</label>
          <input type="number" id="cantidadInput" class="form-control" placeholder="Litros">
        </div>
        <div class="col-md-2">
          <label for="crudoInput" class="form-label">Crudo Usado</label>
          <input type="number" id="crudoInput" class="form-control" readonly>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button id="guardarBtn" class="btn btn-success w-100">Guardar</button>
        </div>
      </div>
      <small class="text-muted">Ingrese la cantidad en litros; las unidades y el crudo se calculan autom√°ticamente.</small>
    </div>

    <!-- Historial de fraccionamientos -->
    <div class="card p-3">
      <h2>üìú Historial de Producci√≥n</h2>
      <div class="table-responsive">
        <table class="table table-striped" id="historialTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Producto</th>
              <th>Presentaci√≥n</th>
              <th>Cantidad</th>
              <th>Litros</th>
              <th>Crudo Usado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzxBOK3uT9_9hjZ1detEzQjmFGmg7mD6O9OT41a5U8KTPgaIUqA-j4ptDTuyRiBQSFNuA/exec"; // reemplaza con tu URL

    let stockData = [];

    // Cargar productos y stock
    async function loadStock() {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=stock`);
        const data = await res.json();
        stockData = data;
        updateCharts();
        updateCrudo();
      } catch (err) {
        console.error("Error al cargar stock:", err);
      }
    }

    // Cargar historial
    async function loadHistorial() {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=fraccionamientos`);
        const data = await res.json();
        const tbody = document.querySelector("#historialTable tbody");
        tbody.innerHTML = "";
        data.forEach(f => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${f.id}</td>
            <td>${new Date(f.fecha).toLocaleString()}</td>
            <td>${f.producto}</td>
            <td>${f.presentacion}</td>
            <td>${f.cantidad}</td>
            <td>${f.litros}</td>
            <td>${f.crudo_usado}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error al cargar historial:", err);
      }
    }

    // Actualizar gr√°ficos
    function updateCharts() {
      const envasesLabels = stockData.map(s => s.item);
      const envasesValues = stockData.map(s => s.stock);

      new Chart(document.getElementById("envasesChart"), {
        type: 'bar',
        data: {
          labels: envasesLabels,
          datasets: [{
            label: 'Stock Envases',
            data: envasesValues,
            backgroundColor: '#007bff'
          }]
        },
        options: { responsive:true, plugins:{legend:{display:false}} }
      });

      // Crudos (puede ser tipo line)
      new Chart(document.getElementById("crudosChart"), {
        type: 'line',
        data: {
          labels: envasesLabels,
          datasets: [{
            label: 'Stock Crudos',
            data: envasesValues,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40,167,69,0.2)',
            fill: true
          }]
        },
        options: { responsive:true, plugins:{legend:{display:false}} }
      });

      // Llenar dropdown de productos
      const productoSelect = document.getElementById("productoSelect");
      productoSelect.innerHTML = "";
      stockData.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.item;
        opt.textContent = p.item;
        productoSelect.appendChild(opt);
      });
    }

    // Calcular crudo autom√°ticamente seg√∫n cantidad
    function updateCrudo() {
      const cantidadInput = document.getElementById("cantidadInput");
      const crudoInput = document.getElementById("crudoInput");
      cantidadInput.addEventListener("input", () => {
        const val = parseFloat(cantidadInput.value) || 0;
        // ejemplo de c√°lculo: crudo = litros * 0.9
        crudoInput.value = (val * 0.9).toFixed(2);
      });
    }

    // Guardar fraccionamiento
    async function guardarFraccionamiento() {
      const producto = document.getElementById("productoSelect").value;
      const presentacion = document.getElementById("presentacionSelect").value;
      const cantidad = document.getElementById("cantidadInput").value;
      const crudo_usado = document.getElementById("crudoInput").value;

      const params = new URLSearchParams();
      params.append
