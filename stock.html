<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    h2 {
      margin-top: 35px;
      text-align: center;
    }

    .panel {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .card {
      background: #020617;
      padding: 18px;
      border-radius: 14px;
      text-align: center;
      box-shadow: 0 0 15px #000;
    }

    .ok { color:#22c55e; }
    .bajo { color:#facc15; }
    .critico { color:#ef4444; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }

    th, td {
      border: 1px solid #1e293b;
      padding: 7px;
      text-align: center;
    }

    th {
      background: #020617;
    }

    .form-box {
      max-width: 420px;
      margin: 40px auto;
      background: #020617;
      padding: 22px;
      border-radius: 14px;
    }

    .form-box input, .form-box select, .form-box button {
      width: 100%;
      padding: 9px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
    }

    .form-box button {
      background: #22c55e;
      font-weight: bold;
      cursor: pointer;
    }

    @media(max-width:700px){
      .cards{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>

<div class="panel">

  <h2>Stock de Productos Crudos</h2>
  <div class="cards" id="cardsCrudos"></div>

  <h2>Stock de Envases</h2>
  <div class="cards" id="cardsEnvases"></div>

  <h2>Registrar Fraccionamiento</h2>
  <div class="form-box">
    <select id="producto"></select>
    <select id="presentacion"></select>
    <input type="number" id="cantidad" placeholder="Cantidad de unidades">
    <button onclick="guardar()">Guardar</button>
  </div>

  <h2>Historial de Fraccionamientos</h2>
  <table id="tablaHistorial"></table>

</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbzDD0ctHAOcnIsi6et8iObuDmeBPtqUdw3GIS2wjs3vZKVaX8pmu4jb8_SPpDMk2oGb8A/exec";

// =======================
// JSONP HELPER
// =======================

function jsonp(url) {
  const s = document.createElement("script");
  s.src = url + "&callback=" + Math.random().toString().replace(".","");
  document.body.appendChild(s);
}

// =======================
// CONFIG
// =======================

function cargarConfig(data) {
  producto.innerHTML = "";
  presentacion.innerHTML = "";

  data.productos.forEach(p=>{
    producto.innerHTML += `<option>${p[0]}</option>`;
  });

  data.envases.forEach(e=>{
    presentacion.innerHTML += `<option>${e[0]}</option>`;
  });
}

window["callback_config"] = cargarConfig;

// =======================
// STOCK
// =======================

function cargarStock(data) {

  cardsCrudos.innerHTML = "";
  data.productos.forEach(p=>{
    cardsCrudos.innerHTML += `
      <div class="card">
        <b>${p.nombre}</b><br>
        ${p.stock.toFixed(2)} L<br>
        <span class="${p.estado.toLowerCase()}">${p.estado}</span>
      </div>`;
  });

  cardsEnvases.innerHTML = "";
  data.envases.forEach(e=>{
    cardsEnvases.innerHTML += `
      <div class="card">
        <b>${e.nombre}</b><br>
        ${e.stock} un<br>
        <span class="${e.estado.toLowerCase()}">${e.estado}</span>
      </div>`;
  });

}

window["callback_stock"] = cargarStock;

// =======================
// HISTORIAL
// =======================

function cargarHistorial(data) {
  let t = `
  <tr>
    <th>Fecha</th>
    <th>Producto</th>
    <th>Envase</th>
    <th>Unidades</th>
    <th>Crudo (L)</th>
    <th>Agua (L)</th>
  </tr>`;

  data.forEach(r=>{
    t += `
      <tr>
        <td>${new Date(r.fecha).toLocaleString()}</td>
        <td>${r.producto}</td>
        <td>${r.presentacion}</td>
        <td>${r.cantidad}</td>
        <td>${r.litrosCrudo.toFixed(2)}</td>
        <td>${r.litrosAgua.toFixed(2)}</td>
      </tr>`;
  });

  tablaHistorial.innerHTML = t;
}

window["callback_frac"] = cargarHistorial;

// =======================
// GUARDAR
// =======================

function guardar() {
  fetch(URL, {
    method: "POST",
    body: JSON.stringify({
      producto: producto.value,
      presentacion: presentacion.value,
      cantidad: Number(cantidad.value)
    })
  });

  cantidad.value = "";
  setTimeout(actualizarTodo,1500);
}

// =======================
// ACTUALIZAR
// =======================

function actualizarTodo() {
  const ts = Date.now();
  jsonp(`${URL}?action=config&nocache=${ts}&callback=callback_config`);
  jsonp(`${URL}?action=stock&nocache=${ts}&callback=callback_stock`);
  jsonp(`${URL}?action=fraccionamientos&nocache=${ts}&callback=callback_frac`);
}

actualizarTodo();
setInterval(actualizarTodo, 8000);

</script>

</body>
</html>
