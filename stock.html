<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Stock</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!--<script>
function setTheme(theme){
  document.body.className = "";
  if(theme !== "dev"){
    document.body.classList.add("theme-" + theme);
  }
}
</script>-->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
body { font-family:'Arial',sans-serif; background:#0e1726; color:#fff; padding:20px; margin:0; }
h2 { border-bottom:2px solid #1abc9c; padding-bottom:5px; }
.container { max-width:1200px; margin:auto; }
table { width:100%; border-collapse:collapse; margin-top:15px; table-layout:auto; }
th, td { border:1px solid #444; padding:8px; text-align:center; }
th { background:#1abc9c; color:#000; position:sticky; top:0; }
tr:nth-child(even) { background:#192339; }
input, select, button { padding:8px; margin:5px 0; width:100%; box-sizing:border-box; border-radius:5px; border:1px solid #444; background:#1f2a40; color:#fff; }
button { background:#1abc9c; border:none; font-weight:bold; cursor:pointer; transition: background 0.3s; }
button:hover { background:#16a085; }
.input-group { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
.input-group > * { flex:1 1 150px; }
.small-text { font-size:12px; color:#aaa; margin-top:-5px; }
@media(max-width:600px){ .input-group { flex-direction:column; } }
</style>
</head>
  
  <!--<section class="theme-selector">
  <h2>Selector de Estilos por Rubro</h2>
  <p>Probá cómo puede verse tu proyecto en distintos rubros.</p>
  <div class="theme-buttons">
    <button onclick="setTheme('dev')">Tech / Programador</button>
    <button onclick="setTheme('art')">Artista Plástico</button>
    <button onclick="setTheme('music')">Músico</button>
    <button onclick="setTheme('law')">Abogado</button>
    <button onclick="setTheme('health')">ONG de Salud</button>
    <button onclick="setTheme('coop')">Cooperativa</button>
    <button onclick="setTheme('telecom')">PyME Telecom</button>
  </div>
</section>-->
<body>
<div class="container">

<h2>Stock Actual</h2>
<canvas id="chartStock" height="150"></canvas>
<table id="tablaStock" class="display"></table>

<h2>Registrar Fraccionamiento</h2>
<div class="input-group">
  <select id="producto"></select>
  <select id="presentacion"></select>
  <input type="number" id="litros" placeholder="Litros finales">
  <input type="number" id="unidades" placeholder="Unidades">
  <input type="text" id="lote" placeholder="Lote">
</div>
<div class="small-text">*Litros finales = cantidad total de líquido producido, incluyendo crudo y agua</div>
<button onclick="guardar()">Guardar Fraccionado</button>

<h2>Historial de Fraccionamientos</h2>
<table id="tablaHistorial" class="display"></table>

<script>
const URL = "https://script.google.com/macros/s/AKfycbyjUiKsm8LBGtuipjJNmQ8x1aEDCfUc87sa3c546CZYZdan42DD3EWOQt31J3jsmQusew/exec";
let chartInstance;

// ================== CARGAR CONFIG ==================
async function cargarConfig(){
  const res = await fetch(`${URL}?action=config`);
  const data = await res.json();
  if(!data.productos || !data.presentaciones) return;

  producto.innerHTML = data.productos.map(p=>`<option value="${p.codigo}" data-d="${p.dilucion}">${p.codigo}</option>`).join("");
  presentacion.innerHTML = data.presentaciones.map(p=>`<option value="${p.litros}">${p.nombre}</option>`).join("");
}

// ================== CARGAR STOCK ==================
async function cargarStock(){
  const res = await fetch(`${URL}?action=stock`);
  const data = await res.json();
  if(!Array.isArray(data) || data.length < 2) return;

  // Preparar datos para gráfico
  const labels = data.slice(1).map(r=>r[0] + " - " + r[2]); // Producto - Presentación
  const cantidades = data.slice(1).map(r=>parseFloat(r[1]) || 0);

  // Renderizar gráfico
  const ctx = document.getElementById('chartStock').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'bar',
    data:{
      labels: labels,
      datasets:[{
        label:'Stock actual (litros)',
        data:cantidades,
        backgroundColor:'rgba(26,188,156,0.7)',
        borderColor:'rgba(26,188,156,1)',
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{
        y:{ beginAtZero:true, title:{ display:true, text:'Cantidad en litros' } },
        x:{ title:{ display:true, text:'Producto - Presentación' } }
      }
    }
  });

  // Tabla de stock
  tablaStock.innerHTML = `<thead><tr>${data[0].map(c=>`<th>${c}</th>`).join("")}</tr></thead>` +
                         `<tbody>${data.slice(1).map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("")}</tbody>`;
  $('#tablaStock').DataTable({ destroy:true });
}

// ================== CARGAR HISTORIAL ==================
async function cargarHistorial(){
  const res = await fetch(`${URL}?action=fraccionamientos`);
  const data = await res.json();
  if(!Array.isArray(data) || !data.length) return;

  tablaHistorial.innerHTML = `<thead><tr>${data[0].map((_,i)=>`<th>${i+1}</th>`).join("")}</tr></thead>` +
                             `<tbody>${data.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("")}</tbody>`;
  $('#tablaHistorial').DataTable({ destroy:true });
}

// ================== AUTO CÁLCULOS ==================
litros.oninput = ()=>{ unidades.value = Math.round(litros.value / presentacion.value); };
unidades.oninput = ()=>{ litros.value = Math.round(unidades.value * presentacion.value * 100)/100; };

// ================== GUARDAR ==================
async function guardar(){
  const crudo = litros.value * producto.selectedOptions[0].dataset.d;
  const agua = litros.value - crudo;

  await fetch(URL,{
    method:"POST",
    body: JSON.stringify({
      producto:producto.value,
      presentacion:presentacion.selectedOptions[0].text,
      unidades:unidades.value,
      lote:lote.value,
      crudo:crudo,
      agua:agua
    }),
    headers:{ "Content-Type":"application/json" }
  });

  litros.value=""; unidades.value=""; lote.value="";
  cargarStock();
  cargarHistorial();
}

// ================== INIT ==================
cargarConfig();
cargarStock();
cargarHistorial();
setInterval(cargarStock, 5000);
</script>

</div>
</body>
</html>
