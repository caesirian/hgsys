<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock y Fraccionamientos - Biotech</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f7f9fb;
    color: #222;
  }

  h2 {
    color: #004080;
    margin-top: 30px;
  }

  .section {
    margin-bottom: 40px;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  table, th, td {
    border: 1px solid #ccc;
  }

  th, td {
    padding: 8px 12px;
    text-align: center;
  }

  th {
    background-color: #004080;
    color: white;
  }

  input[type="number"] {
    width: 80px;
    padding: 5px;
  }

  button {
    background-color: #004080;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
  }

  button:hover {
    background-color: #0066cc;
  }

  .charts {
    display: flex;
    flex-wrap: wrap;
    gap: 40px;
    margin-top: 20px;
  }

  .chart-container {
    flex: 1;
    min-width: 300px;
  }

  @media(max-width:768px){
    .charts {
      flex-direction: column;
    }
  }

</style>
</head>
<body>

<h1>GestiÃ³n de Stock y Fraccionamientos</h1>

<div class="section">
  <h2>ðŸ§´ Indicadores de Stock</h2>
  <div class="charts">
    <div class="chart-container">
      <canvas id="stockEnvases"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="stockCrudos"></canvas>
    </div>
  </div>
</div>

<div class="section">
  <h2>âž• Registrar Fraccionamiento</h2>
  <form id="formFraccionamiento">
    <label>Producto: 
      <select id="productoSelect"></select>
    </label>
    &nbsp;
    <label>PresentaciÃ³n: 
      <select id="presentacionSelect"></select>
    </label>
    &nbsp;
    <label>Cantidad (litros totales): 
      <input type="number" id="cantidadLitros" step="0.01" min="0">
    </label>
    &nbsp;
    <button type="submit">Guardar</button>
  </form>
</div>

<div class="section">
  <h2>ðŸ“œ Historial de Fraccionamientos</h2>
  <table id="tablaHistorial">
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Producto</th>
        <th>PresentaciÃ³n</th>
        <th>Cantidad</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas dinÃ¡micas -->
    </tbody>
  </table>
</div>

<script>
const GAS_URL = "TU_URL_DEL_GAS_AQUI"; // pon tu URL de GAS aquÃ­

async function fetchJSON(url){
  const resp = await fetch(url);
  return await resp.json();
}

async function cargarConfig() {
  const config = await fetchJSON(`${GAS_URL}?action=config&nocache=${Date.now()}`);
  return config;
}

async function cargarStock() {
  const stock = await fetchJSON(`${GAS_URL}?action=stock&nocache=${Date.now()}`);
  return stock;
}

async function cargarFraccionamientos() {
  const fracs = await fetchJSON(`${GAS_URL}?action=fraccionamientos&nocache=${Date.now()}`);
  return fracs;
}

function llenarSelects(stock){
  const productoSelect = document.getElementById("productoSelect");
  const presentacionSelect = document.getElementById("presentacionSelect");
  productoSelect.innerHTML = "";
  presentacionSelect.innerHTML = "";
  stock.forEach(item => {
    const optProd = document.createElement("option");
    optProd.value = item.Producto;
    optProd.textContent = item.Producto;
    productoSelect.appendChild(optProd);

    const optPres = document.createElement("option");
    optPres.value = item.Presentacion;
    optPres.textContent = item.Presentacion;
    presentacionSelect.appendChild(optPres);
  });
}

function llenarTabla(fraccionamientos){
  const tbody = document.querySelector("#tablaHistorial tbody");
  tbody.innerHTML = "";
  fraccionamientos.forEach(f => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.ID}</td>
      <td>${new Date(f.Fecha).toLocaleString()}</td>
      <td>${f.Producto}</td>
      <td>${f.Presentacion}</td>
      <td>${f.Cantidad}</td>
    `;
    tbody.appendChild(tr);
  });
}

function graficarStock(stock){
  const ctxEnvases = document.getElementById('stockEnvases').getContext('2d');
  const ctxCrudos = document.getElementById('stockCrudos').getContext('2d');

  // Grafico de envases (barras)
  new Chart(ctxEnvases, {
    type: 'bar',
    data: {
      labels: stock.map(s => s.Presentacion),
      datasets: [{
        label: 'Cantidad de Envases',
        data: stock.map(s => s.Cantidad),
        backgroundColor: '#004080'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // Grafico de crudos (dona)
  new Chart(ctxCrudos, {
    type: 'doughnut',
    data: {
      labels: stock.map(s => s.Producto),
      datasets: [{
        label: 'Stock Crudo',
        data: stock.map(s => s.Cantidad),
        backgroundColor: ['#004080','#0066cc','#3399ff','#66ccff','#99ddff']
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

document.getElementById("formFraccionamiento").addEventListener("submit", async function(e){
  e.preventDefault();
  alert("Funcionalidad de guardado activada (implementa POST al GAS)");
});

async function init(){
  const stock = await cargarStock();
  llenarSelects(stock);
  graficarStock(stock);

  const fracs = await cargarFraccionamientos();
  llenarTabla(fracs);
}

init();
</script>

</body>
</html>
