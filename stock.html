<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Producción</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#0f172a,#020617);
      color: #e5e7eb;
    }

    h2 {
      margin-top: 40px;
      text-align: center;
      font-weight: 600;
    }

    .panel {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .card {
      background: #020617;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 0 20px #000;
      text-align: center;
    }

    .ok { color:#22c55e; }
    .bajo { color:#facc15; }
    .critico { color:#ef4444; }

    .graficos {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 40px;
    }

    .tabla {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }

    .tabla th, .tabla td {
      border: 1px solid #1e293b;
      padding: 8px;
      text-align: center;
    }

    .tabla th {
      background: #020617;
    }

    .form-box {
      max-width: 420px;
      margin: 40px auto;
      background: #020617;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 0 25px black;
    }

    .form-box input, .form-box select, .form-box button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
    }

    .form-box button {
      background: #22c55e;
      font-weight: bold;
      cursor: pointer;
    }

    .explicacion {
      font-size: 13px;
      opacity: 0.7;
      margin-top: 6px;
      text-align: center;
    }

    @media(max-width:900px){
      .graficos{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
<div class="panel">

  <h2>Stock Actual</h2>
  <div class="cards" id="cardsStock"></div>

  <div class="graficos">
    <canvas id="grafEnvases"></canvas>
    <canvas id="grafCrudos"></canvas>
  </div>

  <table class="tabla" id="tablaStock"></table>

  <h2>Registrar Fraccionamiento</h2>

  <div class="form-box">
    <select id="producto"></select>
    <select id="presentacion"></select>
    <input type="number" id="cantidad" placeholder="Cantidad de unidades">
    <input type="text" id="litrosTotales" placeholder="Litros Totales" readonly>
    <div class="explicacion">
      Litros Totales = capacidad del envase × cantidad de unidades
    </div>
    <button onclick="guardar()">Guardar Fraccionamiento</button>
  </div>

  <h2>Historial de Producción</h2>
  <table class="tabla" id="tablaHistorial"></table>

</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbyWITM6vPi4fGqMoG2Bdbw6eQJhDHGVFJnFzLIwhaOAn8EavXavWJWBZGvpMHLUOcfWAQ/exec";

let envases = [];
let productos = [];

// =======================
// CARGA INICIAL
// =======================

init();

function init(){
  loadConfig();
  loadStock();
  loadHistorial();
  setInterval(loadStock, 8000);
  setInterval(loadHistorial, 8000);
}

// =======================
// CONFIG
// =======================

function loadConfig(){
  fetch(`${URL}?action=config`)
  .then(r=>r.json())
  .then(data=>{
    envases = data.envases;
    productos = data.productos;

    producto.innerHTML = productos.map(p=>`<option>${p[0]}</option>`).join("");
    presentacion.innerHTML = envases.map(e=>`<option>${e[0]}</option>`).join("");

    cantidad.oninput = calcular;
    presentacion.onchange = calcular;
  });
}

function calcular(){
  const env = envases.find(e=>e[0]===presentacion.value);
  if(!env) return;
  const capacidad = Number(env[2]);
  litrosTotales.value = (capacidad * Number(cantidad.value||0)).toFixed(2);
}

// =======================
// STOCK
// =======================

let graf1, graf2;

function loadStock(){
  fetch(`${URL}?action=stock&nocache=${Date.now()}`)
  .then(r=>r.json())
  .then(data=>{

    cardsStock.innerHTML = "";

    data.productos.forEach(p=>{
      cardsStock.innerHTML += `
        <div class="card">
          <b>${p.nombre}</b><br>
          ${p.stock.toFixed(2)} L<br>
          <span class="${p.estado.toLowerCase()}">${p.estado}</span>
        </div>`;
    });

    let t = `<tr><th>Item</th><th>Stock</th><th>Estado</th></tr>`;
    data.envases.forEach(e=>{
      t += `<tr><td>${e.nombre}</td><td>${e.stock}</td><td>${e.estado}</td></tr>`;
    });
    tablaStock.innerHTML = t;

    renderGraficos(data);
  });
}

function renderGraficos(data){
  const le = data.envases.map(e=>e.nombre);
  const ve = data.envases.map(e=>e.stock);

  graf1?.destroy();
  graf1 = new Chart(grafEnvases,{
    type:'bar',
    data:{labels:le,datasets:[{data:ve}]}
  });

  const lp = data.productos.map(p=>p.nombre);
  const vp = data.productos.map(p=>p.stock);

  graf2?.destroy();
  graf2 = new Chart(grafCrudos,{
    type:'doughnut',
    data:{labels:lp,datasets:[{data:vp}]}
  });
}

// =======================
// HISTORIAL
// =======================

function loadHistorial(){
  fetch(`${URL}?action=fraccionamientos&nocache=${Date.now()}`)
  .then(r=>r.json())
  .then(data=>{
    let t = `
      <tr>
        <th>Fecha</th>
        <th>Producto</th>
        <th>Envase</th>
        <th>Unidades</th>
        <th>Crudo (L)</th>
        <th>Agua (L)</th>
      </tr>`;

    data.forEach(r=>{
      t += `
        <tr>
          <td>${new Date(r.fecha).toLocaleString()}</td>
          <td>${r.producto}</td>
          <td>${r.presentacion}</td>
          <td>${r.cantidad}</td>
          <td>${r.litrosCrudo.toFixed(2)}</td>
          <td>${r.litrosAgua.toFixed(2)}</td>
        </tr>`;
    });

    tablaHistorial.innerHTML = t;
  });
}

// =======================
// GUARDAR
// =======================

function guardar(){
  fetch(URL,{
    method:"POST",
    body:JSON.stringify({
      producto: producto.value,
      presentacion: presentacion.value,
      cantidad: Number(cantidad.value)
    })
  });

  cantidad.value = "";
  litrosTotales.value = "";
}
</script>
</body>
</html>
