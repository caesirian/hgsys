<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Stock - BiotecnologÃ­a</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ===== General ===== */
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:20px; background:#f4f6f8; color:#2a3f54; }
h2 { color:#1b2a38; margin-top:30px; }
.table-container { overflow-x:auto; margin-bottom:20px; }
table { border-collapse: collapse; width:100%; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1); border-radius:4px; }
th, td { padding:8px 12px; text-align:left; border-bottom:1px solid #e0e0e0; }
th { background:#1b2a38; color:#fff; }
tr:hover { background:#f1f5f8; }
input, select { padding:6px; margin:4px 0; width:100%; max-width:180px; border:1px solid #ccc; border-radius:4px; }
button { padding:8px 12px; background:#1b2a38; color:#fff; border:none; cursor:pointer; border-radius:4px; transition:0.2s; }
button:hover { background:#0f1a26; }
.graph-container { width:100%; max-width:600px; margin:20px 0; }
label { display:block; margin-top:8px; font-weight:500; }
.form-fraccionamiento { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
.form-fraccionamiento > div { flex:1; min-width:120px; }
</style>
</head>
<body>

<h2>ðŸ§´ Stock Actual</h2>
<div class="table-container">
<table id="stockTable">
  <thead><tr><th>Item</th><th>Stock</th><th>Estado</th></tr></thead>
  <tbody></tbody>
</table>
</div>

<h2>âž• Registrar Fraccionamiento</h2>
<div class="form-fraccionamiento">
  <div>
    <label>Producto</label>
    <select id="productoSelect"></select>
  </div>
  <div>
    <label>PresentaciÃ³n</label>
    <select id="presentacionSelect"></select>
  </div>
  <div>
    <label>Cantidad final (litros)</label>
    <input type="number" id="cantidadInput" min="0" step="0.01" placeholder="Ej: 10">
  </div>
  <div>
    <button onclick="guardarFraccionamiento()">Guardar</button>
  </div>
</div>

<h2>ðŸ“Š GrÃ¡ficos de Stock</h2>
<div class="graph-container">
  <canvas id="stockEnvasesChart"></canvas>
</div>
<div class="graph-container">
  <canvas id="stockCrudosChart"></canvas>
</div>

<h2>ðŸ“œ Historial de Fraccionamientos</h2>
<div class="table-container">
<table id="historialTable">
  <thead><tr><th>ID</th><th>Fecha</th><th>Producto</th><th>PresentaciÃ³n</th><th>Cantidad</th><th>Lote</th></tr></thead>
  <tbody></tbody>
</table>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyPFKyuHfnX-XpZkKDSeHExQ4OlR9efks8a0Visdeq8Q4HxsejVDES3tqq8RHiMrPF-8g/exec";

async function fetchJSON(action){
  const response = await fetch(GAS_URL+"?action="+action+"&nocache="+Date.now());
  return response.json();
}

async function cargarStock() {
  const stock = await fetchJSON("stock");
  const tbody = document.querySelector("#stockTable tbody");
  tbody.innerHTML="";
  stock.slice(1).forEach(row=>{
    const tr=document.createElement("tr");
    row.forEach(cell=>{ const td=document.createElement("td"); td.textContent=cell; tr.appendChild(td); });
    tbody.appendChild(tr);
  });
}

async function cargarConfig() {
  const config = await fetchJSON("config");
  const productoSelect = document.getElementById("productoSelect");
  const presentacionSelect = document.getElementById("presentacionSelect");
  productoSelect.innerHTML=""; presentacionSelect.innerHTML="";
  config.slice(1).forEach(row=>{
    if(row[4]=="ComÃºn") productoSelect.innerHTML += `<option value="${row[0]}">${row[0]}</option>`;
    if(row[4]=="Envase") presentacionSelect.innerHTML += `<option value="${row[0]}">${row[0]}</option>`;
  });
}

async function cargarHistorial() {
  const historial = await fetchJSON("fraccionamientos");
  const tbody = document.querySelector("#historialTable tbody");
  tbody.innerHTML="";
  historial.slice(1).forEach(row=>{
    const tr=document.createElement("tr");
    row.forEach(cell=>{ const td=document.createElement("td"); td.textContent=cell; tr.appendChild(td); });
    tbody.appendChild(tr);
  });
}

async function guardarFraccionamiento() {
  const producto=document.getElementById("productoSelect").value;
  const presentacion=document.getElementById("presentacionSelect").value;
  const cantidad=parseFloat(document.getElementById("cantidadInput").value);
  if(!producto || !presentacion || !cantidad) return alert("Completar todos los campos");
  const litros_crudo = cantidad*0.8; // ejemplo de calculo
  const litros_agua = cantidad*0.2;
  const envases_usados = cantidad/parseFloat(presentacion);
  await fetch(GAS_URL,{method:"POST",body:JSON.stringify({producto,presentacion,cantidad,litros_crudo,litros_agua,envases_usados})});
  document.getElementById("cantidadInput").value="";
  await cargarHistorial();
  await cargarStock();
  cargarGraficos();
}

async function cargarGraficos() {
  const stock = await fetchJSON("stock");
  const labelsEnvases = stock.slice(1,7).map(r=>r[0]);
  const dataEnvases = stock.slice(1,7).map(r=>parseFloat(r[1]));
  const ctxEnv = document.getElementById("stockEnvasesChart").getContext("2d");
  new Chart(ctxEnv,{type:'bar',data:{labels:labelsEnvases,datasets:[{label:'Stock Envases',data:dataEnvases,backgroundColor:'#1b2a38'}]},options:{responsive:true,plugins:{legend:{display:true}}}});

  const labelsCrudos = stock.slice(9,14).map(r=>r[0]);
  const dataCrudos = stock.slice(9,14).map(r=>parseFloat(r[1]));
  const ctxCr = document.getElementById("stockCrudosChart").getContext("2d");
  new Chart(ctxCr,{type:'line',data:{labels:labelsCrudos,datasets:[{label:'Stock Crudos (Lts)',data:dataCrudos,borderColor:'#e67e22',fill:false, tension:0.2}]},options:{responsive:true,plugins:{legend:{display:true}}}});
}

async function init(){
  await cargarConfig();
  await cargarStock();
  await cargarHistorial();
  await cargarGraficos();
}

init();
</script>

</body>
</html>
