<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Stock y Fraccionamiento</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
  .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
  th { background: #4CAF50; color: white; }
</style>
</head>
<body>

<h2>ðŸ§´ Envases</h2>
<div id="envases" class="card"></div>

<h2>âž• Registrar Fraccionamiento</h2>
<div class="card">
  Producto:
  <select id="producto"></select>
  PresentaciÃ³n:
  <select id="presentacion"></select>
  Cantidad Litros:
  <input type="number" id="litros" step="0.01" style="width:80px;">
  <button onclick="guardar()">Guardar</button>
</div>

<h2>ðŸ“œ Historial</h2>
<div class="card">
  <table id="historial">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Producto</th>
        <th>PresentaciÃ³n</th>
        <th>Unidades</th>
        <th>Litros Finales</th>
        <th>Crudo Usado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbxIzvEacYcTWX-ec6f_rX_5QkhxKaER3uW3GRpGryi4-XVsbymBZV9tNpgskw1lt9C3Gw/exec";

// ==== CARGAR CONFIGURACION (PRODUCTOS Y ENVASES) CON JSONP ====
function loadConfig() {
  const script = document.createElement('script');
  script.src = `${URL}?action=config&callback=configCallback&nocache=${Date.now()}`;
  document.body.appendChild(script);
}

function configCallback(data) {
  // Productos
  const prodSelect = document.getElementById("producto");
  data.productos.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p[0];
    opt.text = p[0];
    prodSelect.add(opt);
  });

  // Envases
  const envSelect = document.getElementById("presentacion");
  const envDiv = document.getElementById("envases");
  data.envases.forEach(e => {
    const opt = document.createElement("option");
    opt.value = e[0];
    opt.text = e[0];
    envSelect.add(opt);

    const p = document.createElement("p");
    p.textContent = `${e[0]}: ${e[1]} unidades en stock`;
    envDiv.appendChild(p);
  });

  loadHistorial();
}

// ==== CARGAR HISTORIAL ====
function loadHistorial() {
  const script = document.createElement('script');
  script.src = `${URL}?action=fraccionamientos&callback=historialCallback&nocache=${Date.now()}`;
  document.body.appendChild(script);
}

function historialCallback(data) {
  const tbody = document.querySelector("#historial tbody");
  tbody.innerHTML = "";
  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(r.fecha).toLocaleString()}</td>
      <td>${r.producto}</td>
      <td>${r.presentacion}</td>
      <td>${r.unidades}</td>
      <td>${r.litros_finales}</td>
      <td>${r.crudo_usado}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ==== GUARDAR FRACCIONAMIENTO ====
function guardar() {
  const data = {
    producto: document.getElementById("producto").value,
    presentacion: document.getElementById("presentacion").value,
    litros_finales: parseFloat(document.getElementById("litros").value)
  };

  fetch(URL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(res => {
    if(res.success) {
      alert("Fraccionamiento registrado correctamente");
      loadHistorial();
    } else {
      alert("Error: " + res.error);
    }
  })
  .catch(e => alert("Error al guardar: " + e));
}

// ==== INICIALIZACION ====
loadConfig();
</script>
</body>
</html>
