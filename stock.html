<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Stock Biotecnología</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0e1621;
  color: #eaeaea;
  margin: 0;
  padding: 20px;
}

h2 {
  margin-top: 40px;
  border-bottom: 2px solid #00ff9c;
  padding-bottom: 5px;
}

.card {
  background: #121e2d;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 0 12px #000;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
}

.indicador {
  background: #08131f;
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  border: 1px solid #00ff9c50;
}

.indicador strong {
  font-size: 18px;
  display: block;
  color: #00ff9c;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

th, td {
  padding: 6px;
  border: 1px solid #333;
  text-align: center;
  font-size: 13px;
}

th {
  background: #08131f;
}

input, select, button {
  background: #08131f;
  color: #fff;
  border: 1px solid #00ff9c;
  padding: 6px;
  border-radius: 5px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px,1fr));
  gap: 8px;
  max-width: 700px;
}

button {
  cursor: pointer;
  background: #00ff9c;
  color: #000;
  font-weight: bold;
}

canvas {
  max-width: 100%;
}
</style>
</head>

<body>

<h1>Panel de Stock — Biotecnología</h1>

<!-- INDICADORES -->
<div class="card">
<h2>Indicadores de Stock</h2>
<div class="grid" id="indicadores"></div>
</div>

<!-- GRAFICOS -->
<div class="card">
<h2>Stock de Envases</h2>
<canvas id="grafEnvases"></canvas>
</div>

<div class="card">
<h2>Stock de Crudos</h2>
<canvas id="grafCrudos"></canvas>
</div>

<!-- FORMULARIO -->
<div class="card">
<h2>Registrar Fraccionado</h2>

<div class="form-grid">
  <select id="producto"></select>
  <select id="envase"></select>
  <input type="number" id="litros" placeholder="Litros Finales">
  <input type="number" id="unidades" placeholder="Unidades">
  <input type="number" id="crudo" placeholder="Crudo Usado (L)">
  <button onclick="guardar()">Guardar</button>
</div>

<p style="font-size:12px;color:#aaa;">
<strong>Litros Totales:</strong> representa el volumen final producido luego del fraccionado.
</p>
</div>

<!-- HISTORIAL -->
<div class="card">
<h2>Historial de Producción</h2>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>Producto</th>
  <th>Envase</th>
  <th>Unidades</th>
  <th>Litros</th>
  <th>Crudo</th>
</tr>
</thead>
<tbody id="historial"></tbody>
</table>

</div>

<script>
const URL = "https://script.google.com/macros/library/d/1WBwxohtl88oxpoXwWIii8qZwbTF0_43_9ni3dfHXXq8ghzDZEQym7Rvy/8";

async function init(){
  await loadConfig();
  await loadStock();
  await loadHistorial();
}

async function loadConfig(){
  const r = await fetch(`${URL}?action=config&nocache=${Date.now()}`);
  const data = await r.json();

  const p = document.getElementById("producto");
  const e = document.getElementById("envase");

  data.productos.forEach(x=>{
    p.innerHTML += `<option value="${x.codigo}">${x.nombre}</option>`;
  });

  data.envases.forEach(x=>{
    e.innerHTML += `<option value="${x.codigo}">${x.nombre}</option>`;
  });
}

async function loadStock(){
  const r = await fetch(`${URL}?action=stock&nocache=${Date.now()}`);
  const data = await r.json();

  const ind = document.getElementById("indicadores");
  ind.innerHTML = "";

  let lblEnv=[], valEnv=[], lblCru=[], valCru=[];

  data.envases.forEach(x=>{
    ind.innerHTML += `<div class="indicador"><strong>${x.stock}</strong>${x.nombre}</div>`;
    lblEnv.push(x.nombre); valEnv.push(x.stock);
  });

  data.crudos.forEach(x=>{
    lblCru.push(x.nombre); valCru.push(x.stock);
  });

  new Chart(document.getElementById("grafEnvases"), {
    type: 'bar',
    data: { labels: lblEnv, datasets: [{ data: valEnv }] }
  });

  new Chart(document.getElementById("grafCrudos"), {
    type: 'line',
    data: { labels: lblCru, datasets: [{ data: valCru }] }
  });
}

async function guardar(){
  const body = {
    producto: producto.value,
    envase: envase.value,
    litros: litros.value,
    unidades: unidades.value,
    crudo: crudo.value
  };

  await fetch(URL, {
    method: "POST",
    body: JSON.stringify(body)
  });

  litros.value = unidades.value = crudo.value = "";

  loadStock();
  loadHistorial();
}

async function loadHistorial(){
  const r = await fetch(`${URL}?action=fraccionamientos&nocache=${Date.now()}`);
  const data = await r.json();

  const h = document.getElementById("historial");
  h.innerHTML = "";

  data.reverse().forEach(x=>{
    h.innerHTML += `
      <tr>
        <td>${new Date(x.fecha).toLocaleString()}</td>
        <td>${x.producto}</td>
        <td>${x.envase}</td>
        <td>${x.unidades}</td>
        <td>${x.litros}</td>
        <td>${x.crudo}</td>
      </tr>
    `;
  });
}

init();
</script>

</body>
</html>
