<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Módulo de Fraccionamiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#0f172a;
      color:#e5e7eb;
      padding:20px;
    }

    h2,h3{
      margin-bottom:10px;
      color:#93c5fd;
    }

    .card{
      background:#020617;
      border:1px solid #1e3a8a;
      border-radius:8px;
      padding:16px;
      margin-bottom:20px;
      box-shadow:0 0 10px rgba(30,58,138,.3);
    }

    label{
      display:block;
      margin-top:8px;
      font-size:14px;
    }

    select,input,button{
      width:100%;
      padding:10px;
      margin-top:4px;
      border-radius:4px;
      border:1px solid #1e3a8a;
      background:#020617;
      color:#fff;
      font-size:15px;
    }

    button{
      background:#22c55e;
      border:none;
      color:#000;
      font-weight:bold;
      cursor:pointer;
      margin-top:12px;
    }

    button:hover{
      background:#16a34a;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }

    th,td{
      border:1px solid #1e3a8a;
      padding:8px;
      text-align:center;
    }

    th{
      background:#020617;
      color:#93c5fd;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .msg{
      margin-top:10px;
      color:#4ade80;
      font-weight:bold;
    }
  </style>
</head>

<body>

<h2>Módulo de Fraccionamiento</h2>

<!-- ================== STOCK ================== -->
<div class="card">
  <h3>Stock Actual</h3>
  <table id="tablaStock">
    <thead>
      <tr>
        <th>Item</th>
        <th>Stock</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ================== FORM ================== -->
<div class="card">
  <h3>Registrar Fraccionamiento</h3>

  <label>Producto</label>
  <select id="producto"></select>

  <label>Presentación / Envase</label>
  <select id="presentacion"></select>

  <div class="grid">
    <div>
      <label>Unidades</label>
      <input id="unidades" placeholder="Ej: 120">
    </div>
    <div>
      <label>Litros Finales</label>
      <input id="litrosFinales" placeholder="Ej: 45,5">
    </div>
  </div>

  <div class="grid">
    <div>
      <label>Litros Crudo</label>
      <input id="litrosCrudo" readonly>
    </div>
    <div>
      <label>Litros Agua</label>
      <input id="litrosAgua" readonly>
    </div>
  </div>

  <label>Lote (opcional)</label>
  <input id="lote" placeholder="LOTE-001">

  <button onclick="guardar()">Guardar Fraccionamiento</button>

  <div class="msg" id="mensaje"></div>
</div>

<!-- ================== HISTORIAL ================== -->
<div class="card">
  <h3>Historial de Fraccionamientos</h3>
  <table id="tablaHistorial">
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Producto</th>
        <th>Envase</th>
        <th>Unidades</th>
        <th>Lote</th>
        <th>Crudo</th>
        <th>Agua</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/* ============================
   CONFIGURACIÓN
============================ */

const API_URL = "https://script.google.com/macros/s/AKfycbz9limH6aiZ9Dzvlr2_FgZNebEaA5FrmgaiIRaajibDrDUibGv6rztWud5BR-bPo_4ZEA/exec"; 

let CONFIG = { productos:[], presentaciones:[] };

/* ============================
   UTILIDADES NUMÉRICAS
============================ */

function parseAR(v){
  if(!v) return 0;
  v = v.replace(/\./g,"").replace(",",".");
  return Number(v)||0;
}

function formatAR(n){
  return Number(n||0).toLocaleString("es-AR",{minimumFractionDigits:2});
}

/* ============================
   CARGA INICIAL
============================ */

async function cargarTodo(){
  await cargarConfig();
  await cargarStock();
  await cargarHistorial();
}

async function cargarConfig(){
  let r = await fetch(API_URL+"?action=config&x="+Date.now());
  let j = await r.json();
  CONFIG = j;

  let prodSel = document.getElementById("producto");
  let presSel = document.getElementById("presentacion");

  prodSel.innerHTML = "";
  presSel.innerHTML = "";

  j.productos.forEach(p=>{
    let o=document.createElement("option");
    o.value=p.codigo;
    o.text=p.codigo;
    prodSel.appendChild(o);
  });

  j.presentaciones.forEach(p=>{
    let o=document.createElement("option");
    o.value=p.nombre;
    o.text=p.nombre+" ("+p.capacidad+" L)";
    presSel.appendChild(o);
  });
}

async function cargarStock(){
  let r = await fetch(API_URL+"?action=stock&x="+Date.now());
  let j = await r.json();

  let tb = document.querySelector("#tablaStock tbody");
  tb.innerHTML = "";

  j.stock.forEach(f=>{
    tb.innerHTML += `<tr>
      <td>${f[0]}</td>
      <td>${formatAR(f[1])}</td>
      <td>${f[2]}</td>
    </tr>`;
  });
}

async function cargarHistorial(){
  let r = await fetch(API_URL+"?action=fraccionamientos&x="+Date.now());
  let j = await r.json();

  let tb = document.querySelector("#tablaHistorial tbody");
  tb.innerHTML = "";

  j.fraccionamientos.forEach(f=>{
    tb.innerHTML += `<tr>
      <td>${f[0]}</td>
      <td>${new Date(f[1]).toLocaleString()}</td>
      <td>${f[2]}</td>
      <td>${f[3]}</td>
      <td>${f[4]}</td>
      <td>${f[5]}</td>
      <td>${formatAR(f[6])}</td>
      <td>${formatAR(f[7])}</td>
    </tr>`;
  });
}

/* ============================
   CÁLCULOS AUTOMÁTICOS
============================ */

function recalcular(){
  let pres = document.getElementById("presentacion").value;
  let prod = document.getElementById("producto").value;
  let uni = parseAR(document.getElementById("unidades").value);
  let lit = parseAR(document.getElementById("litrosFinales").value);

  let cap = CONFIG.presentaciones.find(p=>p.nombre===pres)?.capacidad||0;
  let dil = CONFIG.productos.find(p=>p.codigo===prod)?.dilucion||0;

  if(uni>0){
    lit = uni * cap;
    document.getElementById("litrosFinales").value = lit.toString().replace(".",",");
  } else if(lit>0){
    uni = Math.round(lit / cap);
    document.getElementById("unidades").value = uni;
  }

  let crudo = lit * (1-dil);
  let agua  = lit - crudo;

  document.getElementById("litrosCrudo").value = formatAR(crudo);
  document.getElementById("litrosAgua").value  = formatAR(agua);
}

document.getElementById("unidades").addEventListener("input",recalcular);
document.getElementById("litrosFinales").addEventListener("input",recalcular);
document.getElementById("producto").addEventListener("change",recalcular);
document.getElementById("presentacion").addEventListener("change",recalcular);

/* ============================
   GUARDAR
============================ */

async function guardar(){
  let data = {
    producto: producto.value,
    presentacion: presentacion.value,
    cantidad: unidades.value,
    litrosFinal: litrosFinales.value,
    lote: lote.value
  };

  let r = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(data)
  });

  let j = await r.json();
  mensaje.innerHTML = j.success ? "✅ Fraccionamiento registrado" : "❌ Error";

  await cargarStock();
  await cargarHistorial();

  unidades.value="";
  litrosFinales.value="";
  litrosCrudo.value="";
  litrosAgua.value="";
  lote.value="";
}

cargarTodo();
setInterval(cargarStock, 5000);
</script>

</body>
</html>
