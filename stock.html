<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock y Fraccionamientos - Biotech</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #f7f9fb;
    color: #222;
  }

  h2 {
    color: #004080;
    margin-top: 30px;
  }

  .section {
    margin-bottom: 40px;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  table, th, td {
    border: 1px solid #ccc;
  }

  th, td {
    padding: 8px 12px;
    text-align: center;
  }

  th {
    background-color: #004080;
    color: white;
  }

  input[type="number"], select {
    width: 150px;
    padding: 8px;
    margin: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  button {
    background-color: #004080;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 10px;
  }

  button:hover {
    background-color: #0066cc;
  }

  .charts {
    display: flex;
    flex-wrap: wrap;
    gap: 40px;
    margin-top: 20px;
  }

  .chart-container {
    flex: 1;
    min-width: 300px;
    height: 300px;
  }

  .form-group {
    margin: 10px 0;
  }

  label {
    display: inline-block;
    width: 150px;
    font-weight: bold;
  }

  .loading {
    color: #666;
    font-style: italic;
  }

  .error {
    color: #d32f2f;
    background-color: #ffebee;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
  }

  .success {
    color: #2e7d32;
    background-color: #e8f5e9;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
  }

  @media(max-width:768px){
    .charts {
      flex-direction: column;
    }
    
    label {
      display: block;
      width: 100%;
      margin-bottom: 5px;
    }
    
    input[type="number"], select {
      width: 100%;
    }
  }

</style>
</head>
<body>

<h1>Gesti√≥n de Stock y Fraccionamientos</h1>

<div class="section">
  <h2>üß¥ Indicadores de Stock</h2>
  <div class="charts">
    <div class="chart-container">
      <canvas id="stockEnvases"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="stockCrudos"></canvas>
    </div>
  </div>
</div>

<div class="section">
  <h2>‚ûï Registrar Fraccionamiento</h2>
  <form id="formFraccionamiento">
    <div class="form-group">
      <label for="productoSelect">Producto:</label>
      <select id="productoSelect" required>
        <option value="">Cargando productos...</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="presentacionSelect">Presentaci√≥n:</label>
      <select id="presentacionSelect" required>
        <option value="">Seleccionar...</option>
        <option value="45ml">45ml</option>
        <option value="200ml">200ml</option>
        <option value="500ml">500ml</option>
        <option value="1lts">1 Litro</option>
        <option value="5lts">5 Litros</option>
        <option value="20lts">20 Litros</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="cantidadLitros">Cantidad (litros):</label>
      <input type="number" id="cantidadLitros" step="0.01" min="0.01" required>
    </div>
    
    <div class="form-group">
      <label for="crudoUsado">Crudo usado:</label>
      <input type="number" id="crudoUsado" step="0.01" readonly>
    </div>
    
    <div id="formMessage"></div>
    
    <button type="submit">Guardar Fraccionamiento</button>
  </form>
</div>

<div class="section">
  <h2>üìú Historial de Fraccionamientos</h2>
  <div id="loadingHistorial" class="loading">Cargando historial...</div>
  <table id="tablaHistorial" style="display: none;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Producto</th>
        <th>Presentaci√≥n</th>
        <th>Cantidad (L)</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas din√°micas -->
    </tbody>
  </table>
</div>

<script>
// REEMPLAZA ESTA URL CON LA URL DE TU GAS
// Para obtenerla: Publicar -> Implementar como aplicaci√≥n web
const GAS_URL = "https://script.google.com/macros/s/AKfycbzxBOK3uT9_9hjZ1detEzQjmFGmg7mD6O9OT41a5U8KTPgaIUqA-j4ptDTuyRiBQSFNuA/exec";

let stockData = [];
let fraccionamientosData = [];

// Funci√≥n para mostrar mensajes
function showMessage(elementId, message, type = 'info') {
  const element = document.getElementById(elementId);
  element.innerHTML = `<div class="${type}">${message}</div>`;
  if (type === 'success') {
    setTimeout(() => element.innerHTML = '', 3000);
  }
}

// Cargar stock desde GAS
async function cargarStock() {
  try {
    const response = await fetch(`${GAS_URL}?action=stock&nocache=${Date.now()}`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    stockData = data;
    return data;
  } catch (error) {
    console.error('Error al cargar stock:', error);
    showMessage('formMessage', `Error al cargar stock: ${error.message}`, 'error');
    return [];
  }
}

// Cargar fraccionamientos desde GAS
async function cargarFraccionamientos() {
  try {
    const loadingElement = document.getElementById('loadingHistorial');
    const tableElement = document.getElementById('tablaHistorial');
    
    const response = await fetch(`${GAS_URL}?action=fraccionamientos&nocache=${Date.now()}`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    fraccionamientosData = data;
    
    // Ocultar loading y mostrar tabla
    if (loadingElement) loadingElement.style.display = 'none';
    if (tableElement) tableElement.style.display = 'table';
    
    return data;
  } catch (error) {
    console.error('Error al cargar fraccionamientos:', error);
    showMessage('formMessage', `Error al cargar historial: ${error.message}`, 'error');
    return [];
  }
}

// Llenar dropdown de productos
function llenarSelects(stock) {
  const productoSelect = document.getElementById("productoSelect");
  
  if (stock.length === 0) {
    productoSelect.innerHTML = '<option value="">No hay productos disponibles</option>';
    return;
  }
  
  // Limpiar opciones actuales
  productoSelect.innerHTML = '';
  
  // Agregar productos √∫nicos
  const productosUnicos = [...new Set(stock.map(item => item.Producto))];
  
  productosUnicos.forEach(producto => {
    const option = document.createElement("option");
    option.value = producto;
    option.textContent = producto;
    productoSelect.appendChild(option);
  });
}

// Llenar tabla de historial
function llenarTabla(fraccionamientos) {
  const tbody = document.querySelector("#tablaHistorial tbody");
  tbody.innerHTML = "";
  
  if (fraccionamientos.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" style="text-align: center; padding: 20px;">No hay registros de fraccionamiento</td>`;
    tbody.appendChild(tr);
    return;
  }
  
  // Ordenar por fecha (m√°s reciente primero)
  fraccionamientos.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));
  
  fraccionamientos.forEach(f => {
    const tr = document.createElement("tr");
    
    // Formatear fecha
    let fechaFormateada = 'Fecha inv√°lida';
    try {
      const fecha = new Date(f.Fecha);
      if (!isNaN(fecha.getTime())) {
        fechaFormateada = fecha.toLocaleString('es-ES');
      }
    } catch (e) {
      console.warn('Error al formatear fecha:', e);
    }
    
    tr.innerHTML = `
      <td>${f.ID || 'N/A'}</td>
      <td>${fechaFormateada}</td>
      <td>${f.Producto || 'N/A'}</td>
      <td>${f.Presentacion || 'N/A'}</td>
      <td>${f.Cantidad || 0}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Crear gr√°ficos
function graficarStock(stock) {
  if (stock.length === 0) return;
  
  // Destruir gr√°ficos existentes si los hay
  const chartInstances = Chart.instances;
  Object.keys(chartInstances).forEach(key => {
    chartInstances[key].destroy();
  });
  
  // Gr√°fico de barras para stock
  const ctxEnvases = document.getElementById('stockEnvases').getContext('2d');
  new Chart(ctxEnvases, {
    type: 'bar',
    data: {
      labels: stock.map(s => s.Producto),
      datasets: [{
        label: 'Cantidad de Envases',
        data: stock.map(s => s.Cantidad),
        backgroundColor: '#004080'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: { 
          beginAtZero: true,
          title: {
            display: true,
            text: 'Cantidad'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Productos'
          }
        }
      }
    }
  });
  
  // Gr√°fico de dona para presentaciones
  const ctxCrudos = document.getElementById('stockCrudos').getContext('2d');
  new Chart(ctxCrudos, {
    type: 'doughnut',
    data: {
      labels: stock.map(s => `${s.Producto} (${s.Presentacion})`),
      datasets: [{
        label: 'Stock por Producto',
        data: stock.map(s => s.Cantidad),
        backgroundColor: [
          '#004080', '#0066cc', '#3399ff', '#66ccff', '#99ddff',
          '#003366', '#0055aa', '#1a75ff', '#4d94ff', '#80b3ff'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          position: 'right',
          labels: {
            boxWidth: 12,
            padding: 15
          }
        }
      }
    }
  });
}

// Calcular crudo usado autom√°ticamente
function setupCrudoCalculation() {
  const cantidadInput = document.getElementById('cantidadLitros');
  const crudoOutput = document.getElementById('crudoUsado');
  
  cantidadInput.addEventListener('input', function() {
    const litros = parseFloat(this.value) || 0;
    // Ejemplo: crudo usado = litros * 0.9 (ajusta seg√∫n tu f√≥rmula)
    const crudoUsado = litros * 0.9;
    crudoOutput.value = crudoUsado.toFixed(2);
  });
}

// Guardar fraccionamiento
async function guardarFraccionamiento(event) {
  event.preventDefault();
  
  const producto = document.getElementById('productoSelect').value;
  const presentacion = document.getElementById('presentacionSelect').value;
  const cantidad = document.getElementById('cantidadLitros').value;
  
  if (!producto || !presentacion || !cantidad || parseFloat(cantidad) <= 0) {
    showMessage('formMessage', 'Por favor complete todos los campos correctamente', 'error');
    return;
  }
  
  const datos = {
    producto: producto,
    presentacion: presentacion,
    cantidad: parseFloat(cantidad)
  };
  
  try {
    showMessage('formMessage', 'Guardando...', 'info');
    
    const response = await fetch(GAS_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(datos)
    });
    
    const result = await response.json();
    
    if (result.success) {
      showMessage('formMessage', '‚úÖ Fraccionamiento guardado exitosamente', 'success');
      
      // Limpiar formulario
      document.getElementById('formFraccionamiento').reset();
      document.getElementById('crudoUsado').value = '';
      
      // Recargar datos
      await recargarDatos();
    } else {
      throw new Error(result.error || 'Error desconocido');
    }
    
  } catch (error) {
    console.error('Error al guardar:', error);
    showMessage('formMessage', `‚ùå Error al guardar: ${error.message}`, 'error');
  }
}

// Recargar todos los datos
async function recargarDatos() {
  stockData = await cargarStock();
  if (stockData.length > 0) {
    llenarSelects(stockData);
    graficarStock(stockData);
  }
  
  fraccionamientosData = await cargarFraccionamientos();
  if (fraccionamientosData.length > 0) {
    llenarTabla(fraccionamientosData);
  }
}

// Inicializar aplicaci√≥n
async function init() {
  console.log('Iniciando aplicaci√≥n...');
  console.log('URL del GAS:', GAS_URL);
  
  // Configurar eventos
  document.getElementById('formFraccionamiento').addEventListener('submit', guardarFraccionamiento);
  setupCrudoCalculation();
  
  // Cargar datos iniciales
  await recargarDatos();
  
  console.log('Aplicaci√≥n inicializada correctamente');
}

// Ejecutar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
