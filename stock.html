<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>GestiÃ³n de Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg: #0f172a;
      --panel: #020617;
      --card: #020617;
      --border: #1e293b;
      --accent: #22c55e;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #94a3b8;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: linear-gradient(180deg, #020617, #0f172a);
      color: var(--text);
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .panel {
      max-width: 1200px;
      margin: auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 25px rgba(0,0,0,.4);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }

    .card h3 {
      margin: 0 0 10px 0;
      color: var(--accent);
      font-size: 16px;
    }

    .item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px dashed var(--border);
      font-size: 14px;
    }

    .low {
      color: var(--danger);
      font-weight: 600;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: #020617;
      border: 1px solid var(--border);
      color: white;
      border-radius: 6px;
    }

    button {
      background: var(--accent);
      color: #032317;
      font-weight: bold;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    th {
      color: var(--muted);
      font-weight: 500;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>

<body>

<h1>Sistema de Stock</h1>

<div class="panel">

  <div class="grid">

    <div class="card">
      <h3>ðŸ“¦ Productos</h3>
      <div id="productos"></div>
    </div>

    <div class="card">
      <h3>ðŸ§´ Envases</h3>
      <div id="envases"></div>
    </div>

    <div class="card">
      <h3>âž• Registrar Fraccionamiento</h3>
      <select id="producto"></select>
      <select id="presentacion"></select>
      <input type="number" id="cantidad" placeholder="Cantidad">
      <button onclick="guardar()">Guardar</button>
    </div>

  </div>

  <br>

  <div class="card">
    <h3>ðŸ“œ Historial</h3>
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Producto</th>
          <th>PresentaciÃ³n</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody id="historial"></tbody>
    </table>
  </div>

</div>

<footer>
  MÃ³dulo de Stock â€“ HGSys
</footer>

<script>
const URL = "https://script.google.com/macros/s/AKfycbzOK8cHzapbJmUkr5trKVa92OAJg-ouPrhedjB0qFljwWHTVKwDx-8rQSq_SxctaEgPjg/exec";

function init() {
  loadConfig();
  loadStock();
  loadHistorial();
}

function jsonp(url, cb) {
  const s = document.createElement("script");
  s.src = `${url}&callback=${cb}`;
  document.body.appendChild(s);
}

function loadConfig() {
  jsonp(`${URL}?action=config`, "cfg");
}

function cfg(data) {
  const p = document.getElementById("producto");
  const e = document.getElementById("presentacion");

  p.innerHTML = data.productos.map(x => `<option>${x[0]}</option>`).join("");
  e.innerHTML = data.envases.map(x => `<option>${x[0]}</option>`).join("");
}

function loadStock() {
  jsonp(`${URL}?action=stock`, "stk");
}

function stk(data) {
  document.getElementById("productos").innerHTML = data.productos.map(p =>
    `<div class="item ${p.stock < 10 ? "low" : ""}">
      <span>${p.nombre}</span>
      <span>${p.stock}</span>
    </div>`
  ).join("");

  document.getElementById("envases").innerHTML = data.envases.map(p =>
    `<div class="item ${p.stock < 10 ? "low" : ""}">
      <span>${p.nombre}</span>
      <span>${p.stock}</span>
    </div>`
  ).join("");
}

function loadHistorial() {
  jsonp(`${URL}?action=fraccionamientos`, "hist");
}

function hist(data) {
  document.getElementById("historial").innerHTML = data.map(r => `
    <tr>
      <td>${new Date(r.fecha).toLocaleDateString()}</td>
      <td>${r.producto}</td>
      <td>${r.presentacion}</td>
      <td>${r.cantidad}</td>
    </tr>
  `).join("");
}

function guardar() {
  const payload = {
    producto: producto.value,
    presentacion: presentacion.value,
    cantidad: cantidad.value
  };

  fetch(URL, {
    method: "POST",
    body: JSON.stringify(payload)
  }).then(() => {
    loadStock();
    loadHistorial();
  });
}

init();
</script>

</body>
</html>
