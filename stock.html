<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Stock</title>
<style>
body{font-family:Arial;background:#0e1726;color:#fff;padding:20px}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #444;padding:8px;text-align:center}
input,select,button{padding:8px;margin:5px;width:100%}
button{background:#1abc9c;border:0;font-weight:bold}
</style>
</head>
<body>

<h2>Stock Actual</h2>
<table id="tablaStock"></table>

<h2>Registrar Fraccionamiento</h2>

<select id="producto"></select>
<select id="presentacion"></select>

<input type="number" id="litros" placeholder="Litros finales">
<input type="number" id="unidades" placeholder="Unidades">
<input type="text" id="lote" placeholder="Lote">

<button onclick="guardar()">Guardar Fraccionado</button>

<h2>Historial</h2>
<table id="tablaHistorial"></table>

<script>
const URL = "PEGAR_TU_URL_ACA";

// ================== CARGAR CONFIG ==================
async function cargarConfig(){
  const res = await fetch(`${URL}?action=config`);
  const data = await res.json();

  producto.innerHTML = data.productos.map(p=>`<option value="${p.codigo}" data-d="${p.dilucion}">${p.codigo}</option>`).join("");
  presentacion.innerHTML = data.presentaciones.map(p=>`<option value="${p.litros}">${p.nombre}</option>`).join("");
}

// ================== CARGAR STOCK ==================
async function cargarStock(){
  const res = await fetch(`${URL}?action=stock`);
  const data = await res.json();
  tablaStock.innerHTML = data.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("");
}

// ================== CARGAR HISTORIAL ==================
async function cargarHistorial(){
  const res = await fetch(`${URL}?action=fraccionamientos`);
  const data = await res.json();
  tablaHistorial.innerHTML = data.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("");
}

// ================== AUTO CÃLCULOS ==================
litros.oninput = ()=>{
  unidades.value = Math.round(litros.value / presentacion.value);
};

unidades.oninput = ()=>{
  litros.value = Math.round(unidades.value * presentacion.value * 100) / 100;
};

// ================== GUARDAR ==================
async function guardar(){
  const crudo = litros.value * producto.selectedOptions[0].dataset.d;
  const agua = litros.value - crudo;

  await fetch(URL,{
    method:"POST",
    body: JSON.stringify({
      producto:producto.value,
      presentacion:presentacion.selectedOptions[0].text,
      unidades:unidades.value,
      lote:lote.value,
      crudo:crudo,
      agua:agua
    })
  });

  litros.value=""; unidades.value=""; lote.value="";
  cargarStock();
  cargarHistorial();
}

// ================== INIT ==================
cargarConfig();
cargarStock();
cargarHistorial();
setInterval(cargarStock, 5000);
</script>

</body>
</html>
