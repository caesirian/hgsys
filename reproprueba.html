<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPROCANN - Formulario de Registro</title>
    <!-- Cargar librer√≠as desde CDN confiables -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .form-content {
            padding: 30px;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            position: relative;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 80px;
            height: 3px;
            background: #e74c3c;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }
        
        label.required::after {
            content: " *";
            color: #e74c3c;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .signature-area {
            border: 3px dashed #bdc3c7;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin: 25px 0;
            background: #f8f9fa;
        }
        
        #signatureCanvas {
            border: 2px solid #95a5a6;
            background: white;
            width: 100%;
            height: 150px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            touch-action: none;
            border-radius: 5px;
        }
        
        .signature-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        button {
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            flex: 2;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #219653, #1e8449);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 83, 0.3);
        }
        
        .btn-success:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            flex: 1;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.3);
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.95rem;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .progress-bar-container {
            width: 100%;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .form-instructions {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
            font-size: 0.95rem;
            color: #495057;
        }
        
        .form-instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .download-link {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            text-align: center;
            animation: slideIn 0.5s ease;
        }
        
        .download-link a {
            display: inline-block;
            padding: 12px 25px;
            background: #27ae60;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .download-link a:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 83, 0.3);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .form-content {
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .header {
                padding: 20px;
            }
        }
        
        .form-group input:invalid, 
        .form-group textarea:invalid {
            border-color: #e74c3c;
        }
        
        .form-group input:valid, 
        .form-group textarea:valid {
            border-color: #2ecc71;
        }
        
        .character-count {
            text-align: right;
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo h2 {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .logo .subtitle {
            color: #3498db;
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* Estilos para el fallback simple de PDF */
        .pdf-fallback {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 210mm;
            height: 297mm;
            background: white;
            padding: 20mm;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <h2>REPROCANN</h2>
                <p class="subtitle">Registro Nacional del Programa de Cannabis</p>
            </div>
            <h1>Formulario de Registro de Paciente</h1>
            <p>Complete el formulario para generar su documento oficial</p>
        </div>
        
        <div class="form-content">
            <div id="statusMessage" class="status-message"></div>
            
            <!-- Barra de progreso -->
            <div class="progress-bar-container" id="progressBarContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            
            <!-- Spinner de carga -->
            <div class="loading-spinner" id="loadingSpinner"></div>
            
            <!-- Enlace de descarga -->
            <div class="download-link" id="downloadLink">
                <p>‚úÖ Su formulario ha sido generado exitosamente</p>
                <a id="downloadButton" href="#" download>üì• Descargar Formulario PDF</a>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                    El documento tambi√©n se ha guardado en nuestro sistema.
                </p>
            </div>
            
            <div class="form-instructions">
                <h3>üìã Instrucciones para completar el formulario:</h3>
                <p>1. Complete todos los campos marcados con <span style="color:#e74c3c;">*</span> (obligatorios)</p>
                <p>2. Realice su firma en el √°rea designada usando el mouse o su dedo</p>
                <p>3. Revise cuidadosamente todos los datos ingresados</p>
                <p>4. Haga clic en "Generar Documento" para obtener su PDF oficial</p>
            </div>
            
            <form id="pacienteForm">
                <div class="section-title">üìù Datos Personales del Paciente</div>
                
                <div class="form-group">
                    <label class="required">Apellido y Nombre</label>
                    <input type="text" id="paciente_apellidonombre" required 
                           placeholder="Ej: P√©rez, Juan Carlos"
                           oninput="updateCharacterCount(this, 'nombreCount', 100)">
                    <div class="character-count">
                        <span id="nombreCount">0</span>/100 caracteres
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="required">DNI</label>
                    <input type="text" id="paciente_doc" required 
                           placeholder="Ej: 12345678" 
                           pattern="\d{7,8}"
                           title="Ingrese 7 u 8 d√≠gitos num√©ricos">
                </div>
                
                <div class="form-group">
                    <label class="required">Fecha de Nacimiento</label>
                    <input type="date" id="paciente_nac" required>
                </div>
                
                <div class="form-group">
                    <label class="required">Domicilio</label>
                    <input type="text" id="paciente_dom" required 
                           placeholder="Calle, N√∫mero, Piso, Departamento"
                           oninput="updateCharacterCount(this, 'domicilioCount', 150)">
                    <div class="character-count">
                        <span id="domicilioCount">0</span>/150 caracteres
                    </div>
                </div>
                
                <!-- FILA: Localidad, Provincia, CP -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="required">Localidad</label>
                        <input type="text" id="paciente_localidad" required 
                               placeholder="Ej: Buenos Aires">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Provincia</label>
                        <input type="text" id="paciente_provincia" required 
                               placeholder="Ej: Buenos Aires">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">C√≥digo Postal</label>
                        <input type="text" id="paciente_codigo_postal" required 
                               placeholder="Ej: 1000">
                    </div>
                </div>
                
                <!-- FILA: Tel√©fono Particular y Tel√©fono Celular -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Tel√©fono Particular</label>
                        <input type="tel" id="paciente_telefono_particular" 
                               placeholder="Ej: 011-1234-5678">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Tel√©fono Celular</label>
                        <input type="tel" id="paciente_telefono_celular" required 
                               placeholder="Ej: 11-1234-5678">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="required">Correo Electr√≥nico</label>
                    <input type="email" id="paciente_email" required 
                           placeholder="ejemplo@correo.com">
                </div>
                
                <div class="form-group">
                    <label class="required">Obra Social</label>
                    <input type="text" id="paciente_obra_social" required 
                           placeholder="Nombre de su obra social"
                           oninput="updateCharacterCount(this, 'obraSocialCount', 100)">
                    <div class="character-count">
                        <span id="obraSocialCount">0</span>/100 caracteres
                    </div>
                </div>
                
                <div class="section-title" style="margin-top: 35px;">üè• Datos M√©dicos</div>
                
                <div class="form-group">
                    <label class="required">Patolog√≠a/Diagn√≥stico</label>
                    <textarea id="patologia" required 
                              placeholder="Describa su condici√≥n m√©dica"
                              oninput="updateCharacterCount(this, 'patologiaCount', 500)"></textarea>
                    <div class="character-count">
                        <span id="patologiaCount">0</span>/500 caracteres
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="required">Tratamiento Actual</label>
                    <textarea id="tratamiento_actual" required 
                              placeholder="Describa su tratamiento actual"
                              oninput="updateCharacterCount(this, 'tratamientoCount', 500)"></textarea>
                    <div class="character-count">
                        <span id="tratamientoCount">0</span>/500 caracteres
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Otros Antecedentes M√©dicos</label>
                    <textarea id="otros_antecedentes" 
                              placeholder="Otros datos m√©dicos relevantes"
                              oninput="updateCharacterCount(this, 'antecedentesCount', 300)"></textarea>
                    <div class="character-count">
                        <span id="antecedentesCount">0</span>/300 caracteres
                    </div>
                </div>
                
                <div class="form-group">
                    <label>C√≥digo de Vinculaci√≥n (opcional)</label>
                    <input type="text" id="codigo_vinculacion" 
                           placeholder="Si tiene un c√≥digo de vinculaci√≥n">
                </div>
                
                <div class="section-title" style="margin-top: 35px;">‚úçÔ∏è Firma del Paciente</div>
                
                <div class="signature-area">
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.95rem;">
                        <strong>Instrucci√≥n:</strong> Firme en el recuadro utilizando el mouse o su dedo en dispositivos t√°ctiles.
                        Su firma es obligatoria para validar el documento.
                    </p>
                    <canvas id="signatureCanvas"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn-danger" id="clearSignatureBtn">
                            üóëÔ∏è Limpiar Firma
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="required">Fecha de Firma</label>
                    <input type="date" id="paciente_fecha" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-success" id="submitBtn">
                        üìÑ Generar Documento
                    </button>
                    <button type="button" class="btn-danger" id="clearFormBtn">
                        üóëÔ∏è Limpiar Todo
                    </button>
                </div>
            </form>
            
            <div style="text-align: center; margin-top: 30px; color: #7f8c8d; font-size: 0.85rem;">
                <p>Este formulario cumple con los requisitos del Registro Nacional del Programa de Cannabis (REPROCANN)</p>
                <p>¬© 2024 - Todos los derechos reservados</p>
            </div>
        </div>
    </div>

    <!-- Contenedor oculto para fallback de PDF -->
    <div id="pdfFallback" class="pdf-fallback"></div>

    <script>
        // URL de tu Google Apps Script - ¬°IMPORTANTE! Cambiar por tu URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzyOLGzytkbr-b-P5JgCwAZHxVt0-AQdncI9Um7dC-jmFkSmi9cHNsbNHW3tlUBYFq4/exec';
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let jsPDFLoaded = false;
        let html2canvasLoaded = false;
        
        // Verificar carga de librer√≠as
        function verificarLibrerias() {
            jsPDFLoaded = typeof window.jspdf !== 'undefined';
            html2canvasLoaded = typeof html2canvas !== 'undefined';
            
            console.log('jsPDF cargado:', jsPDFLoaded);
            console.log('html2canvas cargado:', html2canvasLoaded);
            
            if (!jsPDFLoaded) {
                console.warn('jsPDF no se carg√≥ correctamente. El fallback usar√° m√©todo alternativo.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar librer√≠as despu√©s de un momento
            setTimeout(verificarLibrerias, 1000);
            
            inicializarFirma();
            configurarEventos();
            
            // Establecer fechas por defecto
            const hoy = getFechaActualLocal();
            document.getElementById('paciente_nac').value = hoy;
            document.getElementById('paciente_fecha').value = hoy;
            
            // Inicializar contadores de caracteres
            inicializarContadores();
            
            mostrarEstado('Complete todos los campos del formulario para generar su documento REPROCANN.', 'info');
        });
        
        function inicializarContadores() {
            const inputs = [
                {id: 'paciente_apellidonombre', countId: 'nombreCount', max: 100},
                {id: 'paciente_dom', countId: 'domicilioCount', max: 150},
                {id: 'paciente_obra_social', countId: 'obraSocialCount', max: 100},
                {id: 'patologia', countId: 'patologiaCount', max: 500},
                {id: 'tratamiento_actual', countId: 'tratamientoCount', max: 500},
                {id: 'otros_antecedentes', countId: 'antecedentesCount', max: 300}
            ];
            
            inputs.forEach(input => {
                const element = document.getElementById(input.id);
                if (element) {
                    updateCharacterCount(element, input.countId, input.max);
                }
            });
        }
        
        function updateCharacterCount(element, countId, maxLength) {
            const count = element.value.length;
            const countElement = document.getElementById(countId);
            if (countElement) {
                countElement.textContent = count;
                if (count > maxLength * 0.9) {
                    countElement.style.color = '#e74c3c';
                } else if (count > maxLength * 0.7) {
                    countElement.style.color = '#f39c12';
                } else {
                    countElement.style.color = '#7f8c8d';
                }
            }
        }
        
        function getFechaActualLocal() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function inicializarFirma() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            const ctx = canvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000000';
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            function startDrawing(e) {
                e.preventDefault();
                isDrawing = true;
                const pos = getCoordinates(e);
                [lastX, lastY] = [pos.x, pos.y];
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getCoordinates(e);
                const x = pos.x;
                const y = pos.y;
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
                [lastX, lastY] = [x, y];
            }
            
            function stopDrawing(e) {
                if (!isDrawing) return;
                e.preventDefault();
                isDrawing = false;
                ctx.closePath();
                document.getElementById('signatureCanvas').classList.add('signed');
            }
            
            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                let x, y;
                if (e.type.includes('touch')) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                return { x, y };
            }
            
            function clearCanvas() {
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#000000';
                document.getElementById('signatureCanvas').classList.remove('signed');
                mostrarEstado('Firma limpiada', 'success');
            }
            
            function getSignatureData() {
                return canvas.toDataURL('image/png');
            }
            
            function hasSignature() {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] !== 255 || data[i + 1] !== 255 || data[i + 2] !== 255) {
                        return true;
                    }
                }
                return false;
            }
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            
            canvas.addEventListener('touchstart', function(e) {
                if (e.cancelable) e.preventDefault();
                startDrawing(e);
            }, { passive: false });
            
            canvas.addEventListener('touchmove', function(e) {
                if (e.cancelable) e.preventDefault();
                draw(e);
            }, { passive: false });
            
            canvas.addEventListener('touchend', function(e) {
                if (e.cancelable) e.preventDefault();
                stopDrawing(e);
            }, { passive: false });
            
            canvas.addEventListener('touchcancel', function(e) {
                if (e.cancelable) e.preventDefault();
                stopDrawing(e);
            }, { passive: false });
            
            canvas.clear = clearCanvas;
            canvas.getSignatureData = getSignatureData;
            canvas.hasSignature = hasSignature;
            
            document.getElementById('clearSignatureBtn').addEventListener('click', clearCanvas);
        }
        
        function configurarEventos() {
            document.getElementById('submitBtn').addEventListener('click', async function() {
                const datos = obtenerDatosFormulario();
                if (!validarFormulario()) {
                    mostrarEstado('‚ùå Complete y valide todos los datos obligatorios', 'error');
                    return;
                }
                
                this.disabled = true;
                this.innerHTML = '‚è≥ Generando...';
                
                mostrarEstado('üìÑ Generando su documento REPROCANN...', 'info');
                document.getElementById('progressBarContainer').style.display = 'block';
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('downloadLink').style.display = 'none';
                
                try {
                    // Intentar enviar al Google Apps Script primero
                    await enviarDatosAlScript(datos);
                } catch (error) {
                    console.error('Error al procesar:', error);
                    // Si falla, usar m√©todo de fallback mejorado
                    await generarPDFFallbackMejorado(datos);
                }
            });
            
            document.getElementById('clearFormBtn').addEventListener('click', clearForm);
        }
        
        function obtenerDatosFormulario() {
            const canvas = document.getElementById('signatureCanvas');
            return {
                paciente_apellidonombre: document.getElementById('paciente_apellidonombre').value.trim(),
                paciente_doc: document.getElementById('paciente_doc').value.trim(),
                paciente_nac: document.getElementById('paciente_nac').value,
                paciente_dom: document.getElementById('paciente_dom').value.trim(),
                paciente_localidad: document.getElementById('paciente_localidad').value.trim(),
                paciente_provincia: document.getElementById('paciente_provincia').value.trim(),
                paciente_codigo_postal: document.getElementById('paciente_codigo_postal').value.trim(),
                paciente_telefono_particular: document.getElementById('paciente_telefono_particular').value.trim(),
                paciente_telefono_celular: document.getElementById('paciente_telefono_celular').value.trim(),
                paciente_email: document.getElementById('paciente_email').value.trim(),
                paciente_obra_social: document.getElementById('paciente_obra_social').value.trim(),
                patologia: document.getElementById('patologia').value.trim(),
                tratamiento_actual: document.getElementById('tratamiento_actual').value.trim(),
                otros_antecedentes: document.getElementById('otros_antecedentes').value.trim(),
                codigo_vinculacion: document.getElementById('codigo_vinculacion').value.trim(),
                paciente_firmaclaracion: canvas && canvas.hasSignature ? canvas.getSignatureData() : '',
                paciente_fecha: document.getElementById('paciente_fecha').value,
                timestamp: new Date().toISOString()
            };
        }
        
        function validarFormulario() {
            const datos = obtenerDatosFormulario();
            const camposRequeridos = [
                'paciente_apellidonombre',
                'paciente_doc',
                'paciente_nac',
                'paciente_dom',
                'paciente_localidad',
                'paciente_provincia',
                'paciente_codigo_postal',
                'paciente_telefono_celular',
                'paciente_email',
                'paciente_obra_social',
                'paciente_fecha'
            ];
            
            const camposFaltantes = [];
            for (const campo of camposRequeridos) {
                if (!datos[campo] || datos[campo].toString().trim() === '') {
                    const nombreCampo = campo.replace(/_/g, ' ');
                    camposFaltantes.push(nombreCampo);
                }
            }
            
            if (datos.paciente_doc && !/^\d{7,8}$/.test(datos.paciente_doc)) {
                camposFaltantes.push('DNI (7-8 d√≠gitos)');
            }
            
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas || !canvas.hasSignature || !datos.paciente_firmaclaracion) {
                camposFaltantes.push('Firma del paciente');
            }
            
            if (camposFaltantes.length > 0) {
                mostrarEstado(`‚ùå Campos incompletos: ${camposFaltantes.join(', ')}`, 'error');
                return false;
            }
            
            return true;
        }
        
        async function enviarDatosAlScript(datos) {
            try {
                actualizarProgreso(10);
                
                // Usar modo 'cors' para poder leer la respuesta
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });
                
                actualizarProgreso(50);
                
                if (response.ok) {
                    const result = await response.json();
                    actualizarProgreso(80);
                    
                    if (result.success) {
                        // Si el script devuelve el PDF en base64, crear enlace de descarga
                        if (result.pdfBase64) {
                            await descargarPDFDesdeBase64(result.pdfBase64, result.fileName || `REPROCANN_${datos.paciente_apellidonombre.replace(/\s+/g, '_')}_${datos.paciente_doc}.pdf`);
                        } else if (result.downloadUrl) {
                            // Si tiene URL de descarga
                            window.open(result.downloadUrl, '_blank');
                        }
                        
                        mostrarEstado('‚úÖ Documento generado y guardado exitosamente', 'success');
                        mostrarEnlaceDescarga(result.downloadUrl || '#', result.fileName || 'documento.pdf');
                    } else {
                        throw new Error(result.message || 'Error en el servidor');
                    }
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                actualizarProgreso(100);
                
            } catch (error) {
                console.warn('Error enviando al script, usando fallback:', error);
                throw error; // Propagar para que se use el fallback
            }
        }
        
        async function generarPDFFallbackMejorado(datos) {
            try {
                mostrarEstado('‚ö†Ô∏è Generando documento localmente...', 'info');
                actualizarProgreso(60);
                
                // Verificar si jsPDF est√° disponible
                if (typeof window.jspdf !== 'undefined') {
                    console.log('Usando jsPDF para generar PDF...');
                    await generarPDFConJsPDF(datos);
                } else {
                    console.log('jsPDF no disponible, usando m√©todo alternativo...');
                    await generarPDFAlternativo(datos);
                }
                
                actualizarProgreso(100);
                
            } catch (error) {
                console.error('Error en fallback mejorado:', error);
                mostrarEstado('‚ùå Error al generar el documento. Por favor, intente nuevamente.', 'error');
                
                // Rehabilitar bot√≥n
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').innerHTML = 'üìÑ Generar Documento';
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }
        
        async function generarPDFConJsPDF(datos) {
            try {
                // Usar jsPDF si est√° disponible
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Configurar estilo
                pdf.setFont("helvetica");
                
                // T√≠tulo
                pdf.setFontSize(20);
                pdf.setTextColor(44, 62, 80); // #2c3e50
                pdf.text('FORMULARIO REPROCANN', 105, 20, { align: 'center' });
                
                // L√≠nea decorativa
                pdf.setDrawColor(52, 152, 219); // #3498db
                pdf.setLineWidth(0.5);
                pdf.line(20, 25, 190, 25);
                
                // Subt√≠tulo
                pdf.setFontSize(12);
                pdf.setTextColor(52, 152, 219); // #3498db
                pdf.text('Registro Nacional del Programa de Cannabis', 105, 32, { align: 'center' });
                
                // Informaci√≥n del paciente
                pdf.setFontSize(14);
                pdf.setTextColor(44, 62, 80); // #2c3e50
                pdf.text('DATOS DEL PACIENTE', 20, 45);
                
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                
                let y = 55;
                
                // Primera columna
                pdf.text(`Nombre: ${datos.paciente_apellidonombre}`, 20, y);
                pdf.text(`DNI: ${datos.paciente_doc}`, 20, y + 7);
                pdf.text(`Fecha Nacimiento: ${formatearFecha(datos.paciente_nac)}`, 20, y + 14);
                pdf.text(`Domicilio: ${datos.paciente_dom}`, 20, y + 21);
                
                // Segunda columna
                pdf.text(`Localidad: ${datos.paciente_localidad}`, 110, y);
                pdf.text(`Provincia: ${datos.paciente_provincia}`, 110, y + 7);
                pdf.text(`CP: ${datos.paciente_codigo_postal}`, 110, y + 14);
                pdf.text(`Tel√©fono: ${datos.paciente_telefono_celular}`, 110, y + 21);
                
                y += 35;
                
                // Contacto
                pdf.setFontSize(11);
                pdf.setTextColor(44, 62, 80);
                pdf.text('INFORMACI√ìN DE CONTACTO', 20, y);
                
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                y += 7;
                
                pdf.text(`Email: ${datos.paciente_email}`, 20, y);
                pdf.text(`Obra Social: ${datos.paciente_obra_social}`, 20, y + 7);
                pdf.text(`Tel. Particular: ${datos.paciente_telefono_particular || 'No especificado'}`, 20, y + 14);
                
                y += 25;
                
                // Datos m√©dicos
                pdf.setFontSize(11);
                pdf.setTextColor(44, 62, 80);
                pdf.text('DATOS M√âDICOS', 20, y);
                
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                y += 7;
                
                // Patolog√≠a (con texto ajustado)
                const patologiaLines = pdf.splitTextToSize(`Patolog√≠a/Diagn√≥stico: ${datos.patologia}`, 170);
                pdf.text(patologiaLines, 20, y);
                y += (patologiaLines.length * 5) + 5;
                
                // Tratamiento
                const tratamientoLines = pdf.splitTextToSize(`Tratamiento Actual: ${datos.tratamiento_actual}`, 170);
                pdf.text(tratamientoLines, 20, y);
                y += (tratamientoLines.length * 5) + 5;
                
                // Antecedentes
                if (datos.otros_antecedentes) {
                    const antecedentesLines = pdf.splitTextToSize(`Otros Antecedentes: ${datos.otros_antecedentes}`, 170);
                    pdf.text(antecedentesLines, 20, y);
                    y += (antecedentesLines.length * 5) + 10;
                }
                
                // Firma y fecha
                pdf.setFontSize(11);
                pdf.setTextColor(44, 62, 80);
                pdf.text('DECLARACI√ìN Y FIRMA', 20, y);
                
                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                y += 7;
                
                pdf.text(`Fecha de Firma: ${formatearFecha(datos.paciente_fecha)}`, 20, y);
                pdf.text(`Lugar: ${datos.paciente_localidad}, ${datos.paciente_provincia}`, 20, y + 7);
                
                // √Årea de firma
                pdf.rect(20, y + 15, 80, 30);
                pdf.setFontSize(8);
                pdf.text('Firma del paciente', 22, y + 18);
                
                // Si hay firma digital, intentar agregarla
                if (datos.paciente_firmaclaracion) {
                    try {
                        pdf.addImage(datos.paciente_firmaclaracion, 'PNG', 22, y + 20, 76, 22);
                    } catch (e) {
                        pdf.text('[Firma digital registrada]', 25, y + 35);
                    }
                } else {
                    pdf.text('[Espacio para firma]', 25, y + 35);
                }
                
                // Aclaraci√≥n
                pdf.setFontSize(9);
                pdf.text(`Aclaraci√≥n: ${datos.paciente_apellidonombre}`, 110, y + 25);
                
                // Pie de p√°gina
                pdf.setFontSize(8);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Documento generado el: ${new Date().toLocaleString('es-AR')}`, 105, 285, { align: 'center' });
                pdf.text('Formulario REPROCANN - Documento v√°lido para tr√°mites oficiales', 105, 290, { align: 'center' });
                
                // Generar nombre del archivo
                const nombreArchivo = `REPROCANN_${datos.paciente_apellidonombre.replace(/\s+/g, '_')}_${datos.paciente_doc}.pdf`;
                
                // Descargar el PDF
                pdf.save(nombreArchivo);
                
                // Crear enlace de descarga alternativo
                const blob = pdf.output('blob');
                const url = URL.createObjectURL(blob);
                
                mostrarEnlaceDescarga(url, nombreArchivo);
                mostrarEstado('‚úÖ Documento generado exitosamente', 'success');
                
                // Rehabilitar bot√≥n
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').innerHTML = 'üìÑ Generar Documento';
                
                // Ocultar barra de progreso
                setTimeout(() => {
                    document.getElementById('progressBarContainer').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Error con jsPDF:', error);
                throw error;
            }
        }
        
        async function generarPDFAlternativo(datos) {
            try {
                // M√©todo alternativo: crear un HTML y usar window.print()
                const pdfContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            @page { size: A4; margin: 20mm; }
                            body { font-family: Arial, sans-serif; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .title { font-size: 24px; color: #2c3e50; }
                            .subtitle { font-size: 14px; color: #3498db; }
                            .section { margin-bottom: 20px; }
                            .section-title { 
                                font-size: 16px; 
                                color: #2c3e50; 
                                border-bottom: 2px solid #3498db;
                                padding-bottom: 5px;
                                margin-bottom: 10px;
                            }
                            .field { margin-bottom: 8px; }
                            .label { font-weight: bold; color: #495057; }
                            .signature-box { 
                                border: 1px solid #000; 
                                width: 200px; 
                                height: 80px; 
                                margin-top: 20px;
                                position: relative;
                            }
                            .signature-label { 
                                position: absolute;
                                top: 5px;
                                left: 5px;
                                font-size: 12px;
                                color: #666;
                            }
                            .footer { 
                                margin-top: 50px; 
                                font-size: 10px; 
                                color: #666; 
                                text-align: center;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="title">FORMULARIO REPROCANN</div>
                            <div class="subtitle">Registro Nacional del Programa de Cannabis</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">DATOS DEL PACIENTE</div>
                            <div class="field"><span class="label">Nombre:</span> ${datos.paciente_apellidonombre}</div>
                            <div class="field"><span class="label">DNI:</span> ${datos.paciente_doc}</div>
                            <div class="field"><span class="label">Fecha Nacimiento:</span> ${formatearFecha(datos.paciente_nac)}</div>
                            <div class="field"><span class="label">Domicilio:</span> ${datos.paciente_dom}</div>
                            <div class="field"><span class="label">Localidad:</span> ${datos.paciente_localidad}</div>
                            <div class="field"><span class="label">Provincia:</span> ${datos.paciente_provincia}</div>
                            <div class="field"><span class="label">C√≥digo Postal:</span> ${datos.paciente_codigo_postal}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">INFORMACI√ìN DE CONTACTO</div>
                            <div class="field"><span class="label">Tel√©fono Celular:</span> ${datos.paciente_telefono_celular}</div>
                            <div class="field"><span class="label">Tel√©fono Particular:</span> ${datos.paciente_telefono_particular || 'No especificado'}</div>
                            <div class="field"><span class="label">Email:</span> ${datos.paciente_email}</div>
                            <div class="field"><span class="label">Obra Social:</span> ${datos.paciente_obra_social}</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">DATOS M√âDICOS</div>
                            <div class="field"><span class="label">Patolog√≠a/Diagn√≥stico:</span> ${datos.patologia}</div>
                            <div class="field"><span class="label">Tratamiento Actual:</span> ${datos.tratamiento_actual}</div>
                            ${datos.otros_antecedentes ? `<div class="field"><span class="label">Otros Antecedentes:</span> ${datos.otros_antecedentes}</div>` : ''}
                        </div>
                        
                        <div class="section">
                            <div class="section-title">DECLARACI√ìN Y FIRMA</div>
                            <div class="field"><span class="label">Fecha de Firma:</span> ${formatearFecha(datos.paciente_fecha)}</div>
                            <div class="field"><span class="label">Lugar:</span> ${datos.paciente_localidad}, ${datos.paciente_provincia}</div>
                            <div class="field"><span class="label">Aclaraci√≥n:</span> ${datos.paciente_apellidonombre}</div>
                            
                            <div class="signature-box">
                                <div class="signature-label">Firma del paciente</div>
                                ${datos.paciente_firmaclaracion ? 
                                    `<img src="${datos.paciente_firmaclaracion}" style="width: 100%; height: 100%; object-fit: contain;">` : 
                                    '[Espacio para firma]'}
                            </div>
                        </div>
                        
                        <div class="footer">
                            Documento generado el: ${new Date().toLocaleString('es-AR')}<br>
                            Formulario REPROCANN - Documento v√°lido para tr√°mites oficiales
                        </div>
                    </body>
                    </html>
                `;
                
                // Crear ventana para imprimir
                const printWindow = window.open('', '_blank');
                printWindow.document.write(pdfContent);
                printWindow.document.close();
                
                // Esperar a que cargue y luego imprimir/guardar como PDF
                printWindow.onload = function() {
                    printWindow.focus();
                    printWindow.print();
                    
                    // Cerrar despu√©s de imprimir
                    setTimeout(() => {
                        printWindow.close();
                    }, 1000);
                };
                
                mostrarEstado('‚úÖ Abriendo vista de impresi√≥n. Seleccione "Guardar como PDF" como impresora.', 'success');
                
                // Rehabilitar bot√≥n
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').innerHTML = 'üìÑ Generar Documento';
                
            } catch (error) {
                console.error('Error con m√©todo alternativo:', error);
                throw error;
            }
        }
        
        async function descargarPDFDesdeBase64(base64Data, fileName) {
            try {
                // Convertir base64 a blob
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });
                
                // Crear enlace de descarga
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Liberar memoria
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
            } catch (error) {
                console.error('Error descargando PDF desde base64:', error);
                throw error;
            }
        }
        
        function mostrarEnlaceDescarga(url, fileName) {
            const downloadButton = document.getElementById('downloadButton');
            downloadButton.href = url;
            downloadButton.download = fileName;
            document.getElementById('downloadLink').style.display = 'block';
        }
        
        function formatearFecha(fechaISO) {
            if (!fechaISO) return '';
            
            if (fechaISO.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [anio, mes, dia] = fechaISO.split('-');
                return `${dia}/${mes}/${anio}`;
            }
            
            const fecha = new Date(fechaISO);
            if (isNaN(fecha.getTime())) {
                return fechaISO;
            }
            
            const fechaLocal = new Date(fecha.getTime() - (fecha.getTimezoneOffset() * 60000));
            const dia = String(fechaLocal.getDate()).padStart(2, '0');
            const mes = String(fechaLocal.getMonth() + 1).padStart(2, '0');
            const anio = fechaLocal.getFullYear();
            
            return `${dia}/${mes}/${anio}`;
        }
        
        function actualizarProgreso(porcentaje) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${porcentaje}%`;
            progressBar.textContent = `${porcentaje}%`;
        }
        
        function clearForm() {
            if (confirm('¬øEst√° seguro que desea limpiar todo el formulario? Se perder√°n todos los datos ingresados.')) {
                const inputs = document.querySelectorAll('#pacienteForm input, #pacienteForm textarea');
                inputs.forEach(input => {
                    if (input.type !== 'button' && input.type !== 'submit') {
                        input.value = '';
                    }
                });
                
                const canvas = document.getElementById('signatureCanvas');
                if (canvas && canvas.clear) {
                    canvas.clear();
                }
                
                const hoy = getFechaActualLocal();
                document.getElementById('paciente_nac').value = hoy;
                document.getElementById('paciente_fecha').value = hoy;
                
                inicializarContadores();
                document.getElementById('downloadLink').style.display = 'none';
                document.getElementById('progressBarContainer').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').innerHTML = 'üìÑ Generar Documento';
                
                mostrarEstado('Formulario limpiado. Puede comenzar a completarlo nuevamente.', 'success');
            }
        }
        
        function mostrarEstado(mensaje, tipo) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = mensaje;
            statusDiv.className = `status-message status-${tipo}`;
            statusDiv.style.display = 'block';
            
            if (tipo === 'success' || tipo === 'info') {
                setTimeout(() => {
                    if (statusDiv.textContent === mensaje) {
                        statusDiv.style.display = 'none';
                    }
                }, 5000);
            }
        }
        
        // Validaci√≥n en tiempo real
        document.querySelectorAll('#pacienteForm input, #pacienteForm textarea').forEach(input => {
            input.addEventListener('blur', function() {
                if (this.hasAttribute('required') && !this.value.trim()) {
                    this.style.borderColor = '#e74c3c';
                } else if (this.type === 'email' && this.value && !this.checkValidity()) {
                    this.style.borderColor = '#e74c3c';
                } else {
                    this.style.borderColor = '#2ecc71';
                }
            });
        });
    </script>
</body>
</html>
