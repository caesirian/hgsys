<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HG Sys - Acceso</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
</head>
<body class="login-body">
    <div class="login-container">
        <div class="login-header">
            <h1><i class="fas fa-cubes"></i> HG Sys</h1>
            <p>Sistema Modular B√°sico</p>
        </div>

        <div class="login-content">
            <!-- Estado de Firebase -->
            <div class="firebase-status" id="firebaseStatus">
                <span id="firebaseStatusText">Conectando con Firebase...</span>
            </div>

            <!-- Bot√≥n principal de Google -->
            <button class="google-btn" onclick="handleGoogleSignIn()" id="googleBtn">
                <i class="fab fa-google"></i>
                <span>Iniciar sesi√≥n con Google</span>
            </button>

            <div class="divider">
                <span>Acceso Seguro</span>
            </div>

            <!-- Mensajes de estado -->
            <div class="error-message" id="authError">
                <h4><i class="fas fa-exclamation-triangle"></i> Error de Autenticaci√≥n</h4>
                <p id="authErrorText">Ha ocurrido un error durante el login.</p>
                <button class="retry-btn" onclick="retryLogin()">
                    <i class="fas fa-redo"></i> Intentar nuevamente
                </button>
            </div>

            <div class="access-denied" id="accessDenied">
                <h3><i class="fas fa-exclamation-triangle"></i> Acceso Denegado</h3>
                <p><strong>No ten√©s permiso para ingresar.</strong></p>
                <p>Si cre√©s que deber√≠as tener acceso, comunicate con el administrador.</p>
                <div class="denied-info">
                    <small><strong>Informaci√≥n registrada:</strong></small><br>
                    <small id="deniedInfo">Cuenta: No identificada</small>
                </div>
                <button class="logout-btn" onclick="logoutUser()">
                    <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
                </button>
            </div>

            <div class="authorized-user" id="authorizedUser">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <h3 id="userName">Usuario</h3>
                <p id="userEmail">email@ejemplo.com</p>
                <p><strong>Estado:</strong> <span class="status-authorized">Autorizado</span></p>
            </div>

            <div class="redirect-message" id="redirectMessage">
                <i class="fas fa-check-circle"></i>
                <h3>¬°Acceso autorizado!</h3>
                <p>Redirigiendo al sistema...</p>
            </div>

            <!-- Informaci√≥n de seguridad -->
            <div class="security-info">
                <h4><i class="fas fa-lock"></i> Seguridad del Sistema</h4>
                <ul>
                    <li><i class="fas fa-check"></i> Autenticaci√≥n con Google</li>
                    <li><i class="fas fa-check"></i> Acceso restringido</li>
                    <li><i class="fas fa-check"></i> Sistema modular seguro</li>
                    <li><i class="fas fa-check"></i> Registro de accesos</li>
                </ul>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Verificando acceso...</p>
        </div>
    </div>

    <script src="auth-manager.js"></script>
    <script>
        // =============================================
        // SISTEMA DE LOGIN VOLUNTARIO
        // =============================================
        let auth = null;
        let isInitialized = false;
        let isProcessing = false;

        function initializeFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyCOoMcQ3gMWgoNumTxmqJngDqQDhYqi8Ec",
                    authDomain: "hg-soluciones-f7090.firebaseapp.com",
                    projectId: "hg-soluciones-f7090",
                    storageBucket: "hg-soluciones-f7090.firebasestorage.app",
                    messagingSenderId: "738232898260",
                    appId: "1:738232898260:web:641e6a5732f8020a11a141",
                    measurementId: "G-QXNXRCRPRG"
                };

                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                isInitialized = true;
                
                updateFirebaseStatus('‚úÖ Conectado correctamente', 'connected');
                console.log('‚úÖ Firebase inicializado - Login voluntario');
                
                // üî• NO VERIFICAMOS SESIONES - SOLO MOSTRAMOS BOT√ìN
                document.getElementById('googleBtn').style.display = 'flex';
                
            } catch (error) {
                console.error('‚ùå Error inicializando Firebase:', error);
                updateFirebaseStatus('‚ùå Error de conexi√≥n', 'error');
            }
        }

        async function handleGoogleSignIn() {
            if (isProcessing) return;
            isProcessing = true;

            console.log('üîÑ Iniciando login voluntario...');
            
            if (!isInitialized) {
                showAuthError('Error: Firebase no inicializado');
                isProcessing = false;
                return;
            }

            try {
                hideAllMessages();
                document.getElementById('googleBtn').style.display = 'none';
                showLoading(true, 'Abriendo ventana de Google...');
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                provider.setCustomParameters({
                    prompt: 'select_account',
                    login_hint: ''
                });

                const result = await auth.signInWithPopup(provider);
                console.log('‚úÖ Login exitoso:', result.user.email);
                
                // Verificar autorizaci√≥n
                if (result.user.email === 'hernan.garbarino@gmail.com') {
                    showAuthorizedUser(result.user);
                    setTimeout(() => {
                        window.location.replace('index_mod.html');
                    }, 2000);
                } else {
                    showLoading(false);
                    showAccessDenied(result.user.email);
                    await auth.signOut();
                }
                
            } catch (error) {
                console.error('‚ùå Error en login:', error);
                showLoading(false);
                document.getElementById('googleBtn').style.display = 'flex';
                handleAuthError(error);
            } finally {
                isProcessing = false;
            }
        }

        function handleAuthError(error) {
            let message = 'Error de autenticaci√≥n';
            
            switch (error.code) {
                case 'auth/popup-closed-by-user':
                    message = 'Ventana de login cerrada. Haz clic nuevamente en el bot√≥n.';
                    break;
                case 'auth/popup-blocked':
                    message = 'Popup bloqueado. Permite ventanas emergentes.';
                    break;
                case 'auth/network-request-failed':
                    message = 'Error de red. Verifica tu conexi√≥n.';
                    break;
                default:
                    message = error.message || 'Error desconocido';
            }
            
            showAuthError(message);
        }

        // Funciones de UI
        function updateFirebaseStatus(message, type) {
            const status = document.getElementById('firebaseStatus');
            const text = document.getElementById('firebaseStatusText');
            status.style.display = 'block';
            status.className = `firebase-status ${type}`;
            text.textContent = message;
        }

        function showAuthError(message) {
            document.getElementById('authErrorText').textContent = message;
            document.getElementById('authError').style.display = 'block';
        }

        function showAccessDenied(email) {
            document.getElementById('accessDenied').style.display = 'block';
            document.getElementById('deniedInfo').textContent = `Cuenta: ${email}`;
        }

        function showAuthorizedUser(user) {
            showLoading(false);
            hideAllMessages();
            document.getElementById('authorizedUser').style.display = 'block';
            document.getElementById('redirectMessage').style.display = 'block';
            document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
            document.getElementById('userEmail').textContent = user.email;
            
            const avatar = document.getElementById('userAvatar');
            if (user.photoURL) {
                avatar.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}">`;
            }
        }

        function hideAllMessages() {
            const messages = ['authError', 'accessDenied', 'authorizedUser', 'redirectMessage'];
            messages.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }

        function showLoading(show, text = 'Cargando...') {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            loading.style.display = show ? 'block' : 'none';
            if (show) loadingText.textContent = text;
        }

        function retryLogin() {
            hideAllMessages();
            document.getElementById('googleBtn').style.display = 'flex';
        }

        async function logoutUser() {
            try {
                if (auth?.currentUser) await auth.signOut();
                retryLogin();
            } catch (error) {
                console.error('Error cerrando sesi√≥n:', error);
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ HG Sys - Login voluntario inicializado');
            initializeFirebase();
        });
    </script>
</body>
</html>